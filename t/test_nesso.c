/* Generated by Strada Self-Hosting Compiler */
/* Package: main */
#include "strada_runtime.h"
#include <string.h>
#include <stdint.h>
#include <stdbool.h>
#include <dlfcn.h>
#include <math.h>

/* Top-level C code blocks */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <ctype.h>

/* Explicit POSIX function declarations (needed because _GNU_SOURCE
   is defined after strada_runtime.h is already included) */
extern char *strdup(const char *s);
extern char *strtok_r(char *str, const char *delim, char **saveptr);
extern int strcasecmp(const char *s1, const char *s2);
extern int strncasecmp(const char *s1, const char *s2, size_t n);

/* Always include SQLite as it's commonly available */
#ifndef HAVE_SQLITE3
#define HAVE_SQLITE3 1
#endif

#ifdef HAVE_SQLITE3
#include <sqlite3.h>
#endif

#ifdef HAVE_MYSQL
#include <mysql/mysql.h>
#endif

#ifdef HAVE_POSTGRES
#include <libpq-fe.h>
#endif

/* Database driver types */
typedef enum {
    DBI_DRIVER_NONE = 0,
    DBI_DRIVER_SQLITE,
    DBI_DRIVER_MYSQL,
    DBI_DRIVER_POSTGRES
} DbiDriverType;

/* Database handle structure */
typedef struct DbiHandle {
    DbiDriverType driver;
    void *conn;
    char *dsn;
    char *username;
    char *error_msg;
    int error_code;
    int auto_commit;
    int in_transaction;
    int raise_error;
    int print_error;
    int connected;
} DbiHandle;

/* Statement handle structure */
typedef struct DbiStatement {
    DbiHandle *dbh;
    void *stmt;
    char *sql;
    int num_params;
    int num_columns;
    char **column_names;
    int *column_types;
    int executed;
    int finished;
    void *result;
    int row_count;
    int affected_rows;
#ifdef HAVE_MYSQL
    /* MySQL result binding data */
    MYSQL_BIND *mysql_result_binds;
    unsigned long *mysql_lengths;
    char *mysql_nulls;   /* Use char instead of deprecated my_bool */
    char **mysql_buffers;
    unsigned long *mysql_buffer_sizes;
    /* MySQL parameter binding data */
    MYSQL_BIND *mysql_param_binds;
    unsigned long *mysql_param_lengths;
    char *mysql_param_nulls;
    char **mysql_param_buffers;
    int mysql_params_bound;
#endif
} DbiStatement;

/* Helper: Set error */
static void dbi_set_error(DbiHandle *dbh, int code, const char *msg) {
    if (dbh->error_msg) free(dbh->error_msg);
    dbh->error_code = code;
    dbh->error_msg = msg ? strdup(msg) : NULL;
    if (dbh->print_error && msg) {
        fprintf(stderr, "DBI Error: %s\n", msg);
    }
    if (dbh->raise_error && msg) {
        strada_throw(msg);
    }
}

/* Set raise_error flag */
static void dbi_set_raise_error(DbiHandle *dbh, int flag) {
    if (dbh) dbh->raise_error = flag;
}

/* Helper: Parse DSN string */
static DbiDriverType dbi_parse_dsn(const char *dsn, char **database, char **host, int *port) {
    *database = NULL;
    *host = NULL;
    *port = 0;

    if (!dsn) return DBI_DRIVER_NONE;

    if (strncmp(dsn, "dbi:", 4) != 0 && strncmp(dsn, "DBI:", 4) != 0) {
        if (strncmp(dsn, "sqlite:", 7) == 0 || strncmp(dsn, "SQLite:", 7) == 0) {
            *database = strdup(dsn + 7);
            return DBI_DRIVER_SQLITE;
        }
        return DBI_DRIVER_NONE;
    }

    const char *p = dsn + 4;
    DbiDriverType driver = DBI_DRIVER_NONE;

    if (strncasecmp(p, "sqlite:", 7) == 0) {
        driver = DBI_DRIVER_SQLITE;
        p += 7;
    } else if (strncasecmp(p, "mysql:", 6) == 0) {
        driver = DBI_DRIVER_MYSQL;
        p += 6;
    } else if (strncasecmp(p, "pg:", 3) == 0 || strncasecmp(p, "postgres:", 9) == 0) {
        driver = DBI_DRIVER_POSTGRES;
        p += (strncasecmp(p, "pg:", 3) == 0) ? 3 : 9;
    }

    if (driver == DBI_DRIVER_NONE) return DBI_DRIVER_NONE;

    char *params = strdup(p);
    char *saveptr;
    char *token = strtok_r(params, ";", &saveptr);

    while (token) {
        char *eq = strchr(token, '=');
        if (eq) {
            *eq = '\0';
            char *key = token;
            char *value = eq + 1;
            while (*key && isspace(*key)) key++;
            while (*value && isspace(*value)) value++;

            if (strcasecmp(key, "database") == 0 || strcasecmp(key, "dbname") == 0) {
                *database = strdup(value);
            } else if (strcasecmp(key, "host") == 0) {
                *host = strdup(value);
            } else if (strcasecmp(key, "port") == 0) {
                *port = atoi(value);
            }
        } else {
            if (!*database) {
                *database = strdup(token);
            }
        }
        token = strtok_r(NULL, ";", &saveptr);
    }

    free(params);
    return driver;
}

/* Connect to database */
static DbiHandle* dbi_connect_raw(const char *dsn, const char *user, const char *pass,
                                   int auto_commit, int print_error) {
    DbiHandle *dbh = calloc(1, sizeof(DbiHandle));
    if (!dbh) return NULL;

    dbh->auto_commit = auto_commit;
    dbh->raise_error = 0;
    dbh->print_error = print_error;

    char *database = NULL;
    char *host = NULL;
    int port = 0;

    dbh->driver = dbi_parse_dsn(dsn, &database, &host, &port);
    dbh->dsn = dsn ? strdup(dsn) : NULL;
    dbh->username = user ? strdup(user) : NULL;

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            sqlite3 *db;
            int rc = sqlite3_open(database ? database : ":memory:", &db);
            if (rc != SQLITE_OK) {
                dbi_set_error(dbh, rc, sqlite3_errmsg(db));
                sqlite3_close(db);
                free(database);
                free(host);
                free(dbh->dsn);
                free(dbh->username);
                free(dbh);
                return NULL;
            }
            dbh->conn = db;
            dbh->connected = 1;
            break;
        }
#endif

#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            MYSQL *mysql = mysql_init(NULL);
            if (!mysql) {
                dbi_set_error(dbh, -1, "MySQL initialization failed");
                free(database);
                free(host);
                free(dbh->dsn);
                free(dbh->username);
                free(dbh);
                return NULL;
            }
            if (!mysql_real_connect(mysql, host ? host : "localhost", user, pass,
                                   database, port ? port : 3306, NULL, 0)) {
                dbi_set_error(dbh, mysql_errno(mysql), mysql_error(mysql));
                mysql_close(mysql);
                free(database);
                free(host);
                free(dbh->dsn);
                free(dbh->username);
                free(dbh);
                return NULL;
            }
            if (dbh->auto_commit) mysql_autocommit(mysql, 1);
            dbh->conn = mysql;
            dbh->connected = 1;
            break;
        }
#endif

#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            char conninfo[1024];
            snprintf(conninfo, sizeof(conninfo),
                    "host=%s port=%d dbname=%s user=%s password=%s",
                    host ? host : "localhost", port ? port : 5432,
                    database ? database : "", user ? user : "", pass ? pass : "");
            PGconn *pg = PQconnectdb(conninfo);
            if (PQstatus(pg) != CONNECTION_OK) {
                dbi_set_error(dbh, -1, PQerrorMessage(pg));
                PQfinish(pg);
                free(database);
                free(host);
                free(dbh->dsn);
                free(dbh->username);
                free(dbh);
                return NULL;
            }
            dbh->conn = pg;
            dbh->connected = 1;
            break;
        }
#endif

        default:
            dbi_set_error(dbh, -1, "Unknown or unsupported database driver");
            free(database);
            free(host);
            free(dbh->dsn);
            free(dbh->username);
            free(dbh);
            return NULL;
    }

    free(database);
    free(host);
    return dbh;
}

/* Forward declarations for transaction functions */
static int dbi_do_sql(DbiHandle *dbh, const char *sql);
static int dbi_rollback(DbiHandle *dbh);

/* Disconnect from database */
static void dbi_disconnect(DbiHandle *dbh) {
    if (!dbh) return;

    if (dbh->in_transaction) {
        dbi_rollback(dbh);
    }

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            if (dbh->conn) sqlite3_close((sqlite3*)dbh->conn);
            break;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL:
            if (dbh->conn) mysql_close((MYSQL*)dbh->conn);
            break;
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES:
            if (dbh->conn) PQfinish((PGconn*)dbh->conn);
            break;
#endif
        default:
            break;
    }

    free(dbh->dsn);
    free(dbh->username);
    free(dbh->error_msg);
    free(dbh);
}

/* Ping connection */
static int dbi_ping(DbiHandle *dbh) {
    if (!dbh || !dbh->connected) return 0;

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            return 1;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL:
            return mysql_ping((MYSQL*)dbh->conn) == 0;
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES:
            return PQstatus((PGconn*)dbh->conn) == CONNECTION_OK;
#endif
        default:
            return 0;
    }
}

/* Prepare statement */
static DbiStatement* dbi_prepare(DbiHandle *dbh, const char *sql) {
    if (!dbh || !dbh->connected || !sql) return NULL;

    DbiStatement *sth = calloc(1, sizeof(DbiStatement));
    if (!sth) return NULL;

    sth->dbh = dbh;
    sth->sql = strdup(sql);

    const char *p = sql;
    while ((p = strchr(p, '?')) != NULL) {
        sth->num_params++;
        p++;
    }

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            sqlite3_stmt *stmt;
            int rc = sqlite3_prepare_v2((sqlite3*)dbh->conn, sql, -1, &stmt, NULL);
            if (rc != SQLITE_OK) {
                dbi_set_error(dbh, rc, sqlite3_errmsg((sqlite3*)dbh->conn));
                free(sth->sql);
                free(sth);
                return NULL;
            }
            sth->stmt = stmt;
            sth->num_columns = sqlite3_column_count(stmt);
            if (sth->num_columns > 0) {
                sth->column_names = calloc(sth->num_columns, sizeof(char*));
                for (int i = 0; i < sth->num_columns; i++) {
                    const char *name = sqlite3_column_name(stmt, i);
                    sth->column_names[i] = name ? strdup(name) : strdup("");
                }
            }
            break;
        }
#endif

#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            MYSQL_STMT *stmt = mysql_stmt_init((MYSQL*)dbh->conn);
            if (!stmt || mysql_stmt_prepare(stmt, sql, strlen(sql)) != 0) {
                dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                if (stmt) mysql_stmt_close(stmt);
                free(sth->sql);
                free(sth);
                return NULL;
            }
            sth->stmt = stmt;
            sth->num_params = mysql_stmt_param_count(stmt);

            /* Allocate parameter binding arrays */
            if (sth->num_params > 0) {
                sth->mysql_param_binds = calloc(sth->num_params, sizeof(MYSQL_BIND));
                sth->mysql_param_lengths = calloc(sth->num_params, sizeof(unsigned long));
                sth->mysql_param_nulls = calloc(sth->num_params, sizeof(char));
                sth->mysql_param_buffers = calloc(sth->num_params, sizeof(char*));
                sth->mysql_params_bound = 0;
            }

            MYSQL_RES *meta = mysql_stmt_result_metadata(stmt);
            if (meta) {
                sth->num_columns = mysql_num_fields(meta);
                sth->column_names = calloc(sth->num_columns, sizeof(char*));
                MYSQL_FIELD *fields = mysql_fetch_fields(meta);
                for (int i = 0; i < sth->num_columns; i++) {
                    sth->column_names[i] = strdup(fields[i].name);
                }
                mysql_free_result(meta);
            }
            break;
        }
#endif

#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES:
            sth->stmt = NULL;
            break;
#endif

        default:
            free(sth->sql);
            free(sth);
            return NULL;
    }

    return sth;
}

/* Execute statement */
static int dbi_execute_raw(DbiStatement *sth) {
    if (!sth || !sth->dbh) return -1;

    DbiHandle *dbh = sth->dbh;
    sth->executed = 1;
    sth->finished = 0;

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            sqlite3_stmt *stmt = (sqlite3_stmt*)sth->stmt;
            int rc = sqlite3_step(stmt);
            if (rc == SQLITE_DONE) {
                sth->affected_rows = sqlite3_changes((sqlite3*)dbh->conn);
                sth->finished = 1;
                return sth->affected_rows;
            } else if (rc == SQLITE_ROW) {
                sqlite3_reset(stmt);
                return 0;
            } else {
                dbi_set_error(dbh, rc, sqlite3_errmsg((sqlite3*)dbh->conn));
                return -1;
            }
        }
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            MYSQL_STMT *stmt = (MYSQL_STMT*)sth->stmt;

            /* Bind parameters if any */
            if (sth->num_params > 0 && sth->mysql_param_binds) {
                if (mysql_stmt_bind_param(stmt, sth->mysql_param_binds) != 0) {
                    dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                    return -1;
                }
            }

            if (mysql_stmt_execute(stmt) != 0) {
                dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                return -1;
            }
            sth->affected_rows = mysql_stmt_affected_rows(stmt);

            /* For SELECT queries, store result and set up bindings */
            MYSQL_RES *meta = mysql_stmt_result_metadata(stmt);
            if (meta) {
                /* This is a SELECT - store results and bind columns */
                if (mysql_stmt_store_result(stmt) != 0) {
                    dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                    mysql_free_result(meta);
                    return -1;
                }

                int ncols = sth->num_columns;
                sth->mysql_result_binds = calloc(ncols, sizeof(MYSQL_BIND));
                sth->mysql_lengths = calloc(ncols, sizeof(unsigned long));
                sth->mysql_nulls = calloc(ncols, sizeof(char));  /* Use char for is_null flags */
                sth->mysql_buffers = calloc(ncols, sizeof(char*));
                sth->mysql_buffer_sizes = calloc(ncols, sizeof(unsigned long));

                MYSQL_FIELD *fields = mysql_fetch_fields(meta);
                for (int i = 0; i < ncols; i++) {
                    /* Allocate buffer based on field type */
                    unsigned long bufsize = fields[i].max_length + 1;
                    if (bufsize < 256) bufsize = 256;
                    sth->mysql_buffers[i] = calloc(bufsize, 1);
                    sth->mysql_buffer_sizes[i] = bufsize;

                    sth->mysql_result_binds[i].buffer_type = MYSQL_TYPE_STRING;
                    sth->mysql_result_binds[i].buffer = sth->mysql_buffers[i];
                    sth->mysql_result_binds[i].buffer_length = bufsize;
                    sth->mysql_result_binds[i].length = &sth->mysql_lengths[i];
                    sth->mysql_result_binds[i].is_null = (bool*)&sth->mysql_nulls[i];
                }

                if (mysql_stmt_bind_result(stmt, sth->mysql_result_binds) != 0) {
                    dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                    mysql_free_result(meta);
                    return -1;
                }

                mysql_free_result(meta);
            }
            return sth->affected_rows;
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES:
            return 0;
#endif
        default:
            return -1;
    }
}

/* Bind string parameter */
static void dbi_bind_str(DbiStatement *sth, int idx, const char *val) {
    if (!sth || !sth->dbh) return;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            if (val) {
                sqlite3_bind_text((sqlite3_stmt*)sth->stmt, idx, val, -1, SQLITE_TRANSIENT);
            } else {
                sqlite3_bind_null((sqlite3_stmt*)sth->stmt, idx);
            }
            break;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            int param_idx = idx - 1;  /* MySQL uses 0-based indexing */
            if (param_idx < 0 || param_idx >= sth->num_params) return;

            /* Check that buffers are allocated */
            if (!sth->mysql_param_buffers || !sth->mysql_param_binds) return;

            /* Free old buffer if exists */
            if (sth->mysql_param_buffers[param_idx]) {
                free(sth->mysql_param_buffers[param_idx]);
            }

            if (val) {
                sth->mysql_param_buffers[param_idx] = strdup(val);
                sth->mysql_param_lengths[param_idx] = strlen(val);
                sth->mysql_param_nulls[param_idx] = 0;
                sth->mysql_param_binds[param_idx].buffer_type = MYSQL_TYPE_STRING;
                sth->mysql_param_binds[param_idx].buffer = sth->mysql_param_buffers[param_idx];
                sth->mysql_param_binds[param_idx].buffer_length = sth->mysql_param_lengths[param_idx];
                sth->mysql_param_binds[param_idx].length = &sth->mysql_param_lengths[param_idx];
                sth->mysql_param_binds[param_idx].is_null = (bool*)&sth->mysql_param_nulls[param_idx];
            } else {
                sth->mysql_param_buffers[param_idx] = NULL;
                sth->mysql_param_nulls[param_idx] = 1;
                sth->mysql_param_binds[param_idx].buffer_type = MYSQL_TYPE_NULL;
                sth->mysql_param_binds[param_idx].is_null = (bool*)&sth->mysql_param_nulls[param_idx];
            }
            break;
        }
#endif
        default:
            break;
    }
}

/* Bind null parameter */
static void dbi_bind_null(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            sqlite3_bind_null((sqlite3_stmt*)sth->stmt, idx);
            break;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            int param_idx = idx - 1;  /* MySQL uses 0-based indexing */
            if (param_idx < 0 || param_idx >= sth->num_params) return;
            /* Check that buffers are allocated */
            if (!sth->mysql_param_nulls || !sth->mysql_param_binds) return;
            sth->mysql_param_nulls[param_idx] = 1;
            sth->mysql_param_binds[param_idx].buffer_type = MYSQL_TYPE_NULL;
            sth->mysql_param_binds[param_idx].is_null = (bool*)&sth->mysql_param_nulls[param_idx];
            break;
        }
#endif
        default:
            break;
    }
}

/* Clear bindings */
static void dbi_clear_bindings(DbiStatement *sth) {
    if (!sth || !sth->dbh) return;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            sqlite3_reset((sqlite3_stmt*)sth->stmt);
            sqlite3_clear_bindings((sqlite3_stmt*)sth->stmt);
            break;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL:
            /* Clear the parameter bindings */
            if (sth->mysql_param_binds && sth->num_params > 0) {
                memset(sth->mysql_param_binds, 0, sth->num_params * sizeof(MYSQL_BIND));
                memset(sth->mysql_param_nulls, 0, sth->num_params * sizeof(char));
                memset(sth->mysql_param_lengths, 0, sth->num_params * sizeof(unsigned long));
                for (int i = 0; i < sth->num_params; i++) {
                    if (sth->mysql_param_buffers[i]) {
                        free(sth->mysql_param_buffers[i]);
                        sth->mysql_param_buffers[i] = NULL;
                    }
                }
            }
            break;
#endif
        default:
            break;
    }
}

/* Bind a StradaValue directly - handles type detection and proper memory management */
static void dbi_bind_value(DbiStatement *sth, int idx, StradaValue *val) {
    if (!sth || !sth->dbh || !val) return;

    /* Get the string representation of the value - MUST be freed! */
    char *str = strada_to_str(val);

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            if (str) {
                /* SQLITE_TRANSIENT makes SQLite copy the string, so we can free it */
                sqlite3_bind_text((sqlite3_stmt*)sth->stmt, idx, str, -1, SQLITE_TRANSIENT);
            } else {
                sqlite3_bind_null((sqlite3_stmt*)sth->stmt, idx);
            }
            break;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            int param_idx = idx - 1;  /* MySQL uses 0-based indexing */
            if (param_idx < 0 || param_idx >= sth->num_params) {
                free(str);  /* Don't leak on early return */
                return;
            }

            /* Check that buffers are allocated */
            if (!sth->mysql_param_buffers || !sth->mysql_param_binds) {
                free(str);
                return;
            }

            /* Free old buffer if exists */
            if (sth->mysql_param_buffers[param_idx]) {
                free(sth->mysql_param_buffers[param_idx]);
            }

            if (str && strlen(str) > 0) {
                /* Use the str directly instead of strdup - we own it now */
                sth->mysql_param_buffers[param_idx] = str;
                sth->mysql_param_lengths[param_idx] = strlen(str);
                sth->mysql_param_nulls[param_idx] = 0;
                sth->mysql_param_binds[param_idx].buffer_type = MYSQL_TYPE_STRING;
                sth->mysql_param_binds[param_idx].buffer = sth->mysql_param_buffers[param_idx];
                sth->mysql_param_binds[param_idx].buffer_length = sth->mysql_param_lengths[param_idx];
                sth->mysql_param_binds[param_idx].length = &sth->mysql_param_lengths[param_idx];
                sth->mysql_param_binds[param_idx].is_null = (bool*)&sth->mysql_param_nulls[param_idx];
                str = NULL;  /* Ownership transferred, don't free */
            } else {
                sth->mysql_param_buffers[param_idx] = NULL;
                sth->mysql_param_nulls[param_idx] = 1;
                sth->mysql_param_binds[param_idx].buffer_type = MYSQL_TYPE_NULL;
                sth->mysql_param_binds[param_idx].is_null = (bool*)&sth->mysql_param_nulls[param_idx];
            }
            break;
        }
#endif
        default:
            break;
    }

    /* Free the string if we didn't transfer ownership */
    if (str) {
        free(str);
    }
}

/* Step to next row */
static int dbi_step(DbiStatement *sth) {
    if (!sth || !sth->dbh || !sth->executed) return -1;
    if (sth->finished) return 0;

    DbiHandle *dbh = sth->dbh;

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            int rc = sqlite3_step((sqlite3_stmt*)sth->stmt);
            if (rc == SQLITE_ROW) return 1;
            else if (rc == SQLITE_DONE) {
                sth->finished = 1;
                return 0;
            } else {
                dbi_set_error(dbh, rc, sqlite3_errmsg((sqlite3*)dbh->conn));
                return -1;
            }
        }
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            MYSQL_STMT *stmt = (MYSQL_STMT*)sth->stmt;
            int rc = mysql_stmt_fetch(stmt);
            if (rc == 0) {
                sth->row_count++;
                return 1;  /* Row available */
            } else if (rc == MYSQL_NO_DATA) {
                sth->finished = 1;
                return 0;  /* No more rows */
            } else if (rc == MYSQL_DATA_TRUNCATED) {
                /* Data was truncated but still available */
                sth->row_count++;
                return 1;
            } else {
                dbi_set_error(dbh, mysql_stmt_errno(stmt), mysql_stmt_error(stmt));
                return -1;
            }
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES:
            if (!sth->result) return 0;
            if (sth->row_count < PQntuples((PGresult*)sth->result)) return 1;
            sth->finished = 1;
            return 0;
#endif
        default:
            return -1;
    }
}

/* Get column count */
static int dbi_column_count(DbiStatement *sth) {
    return sth ? sth->num_columns : 0;
}

/* Get column name */
static char* dbi_column_name(DbiStatement *sth, int idx) {
    if (!sth || !sth->column_names || idx < 0 || idx >= sth->num_columns) {
        return strdup("");
    }
    return strdup(sth->column_names[idx]);
}

/* Get column type: 0=null, 1=int, 2=num, 3=str */
static int dbi_column_type(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return 0;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            int type = sqlite3_column_type((sqlite3_stmt*)sth->stmt, idx);
            switch (type) {
                case SQLITE_NULL:    return 0;
                case SQLITE_INTEGER: return 1;
                case SQLITE_FLOAT:   return 2;
                default:             return 3;
            }
        }
#endif
        default:
            return 3;
    }
}

/* Get column as int */
static int64_t dbi_column_int(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return 0;
    if (idx < 0 || idx >= sth->num_columns) return 0;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            return sqlite3_column_int64((sqlite3_stmt*)sth->stmt, idx);
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            if (!sth->mysql_buffers || sth->mysql_nulls[idx]) return 0;
            return strtoll(sth->mysql_buffers[idx], NULL, 10);
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            if (!sth->result) return 0;
            PGresult *res = (PGresult*)sth->result;
            int row = sth->affected_rows;
            if (PQgetisnull(res, row, idx)) return 0;
            return strtoll(PQgetvalue(res, row, idx), NULL, 10);
        }
#endif
        default:
            return 0;
    }
}

/* Get column as double */
static double dbi_column_num(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return 0.0;
    if (idx < 0 || idx >= sth->num_columns) return 0.0;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            return sqlite3_column_double((sqlite3_stmt*)sth->stmt, idx);
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            if (!sth->mysql_buffers || sth->mysql_nulls[idx]) return 0.0;
            return strtod(sth->mysql_buffers[idx], NULL);
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            if (!sth->result) return 0.0;
            PGresult *res = (PGresult*)sth->result;
            int row = sth->affected_rows;
            if (PQgetisnull(res, row, idx)) return 0.0;
            return strtod(PQgetvalue(res, row, idx), NULL);
        }
#endif
        default:
            return 0.0;
    }
}

/* Get column as string */
static char* dbi_column_str(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return strdup("");
    if (idx < 0 || idx >= sth->num_columns) return strdup("");

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE: {
            const char *text = (const char*)sqlite3_column_text((sqlite3_stmt*)sth->stmt, idx);
            return strdup(text ? text : "");
        }
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            if (!sth->mysql_buffers || sth->mysql_nulls[idx]) return strdup("");
            return strdup(sth->mysql_buffers[idx]);
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            if (!sth->result) return strdup("");
            PGresult *res = (PGresult*)sth->result;
            int row = sth->affected_rows;
            if (PQgetisnull(res, row, idx)) return strdup("");
            return strdup(PQgetvalue(res, row, idx));
        }
#endif
        default:
            return strdup("");
    }
}

/* Check if column is null */
static int dbi_column_is_null(DbiStatement *sth, int idx) {
    if (!sth || !sth->dbh) return 1;
    if (idx < 0 || idx >= sth->num_columns) return 1;

    switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            return sqlite3_column_type((sqlite3_stmt*)sth->stmt, idx) == SQLITE_NULL;
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL: {
            if (!sth->mysql_nulls) return 1;
            return sth->mysql_nulls[idx] ? 1 : 0;
        }
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            if (!sth->result) return 1;
            return PQgetisnull((PGresult*)sth->result, sth->affected_rows, idx);
        }
#endif
        default:
            return 1;
    }
}

/* Finish statement */
static void dbi_finish(DbiStatement *sth) {
    if (!sth) return;
    sth->finished = 1;

#ifdef HAVE_SQLITE3
    if (sth->dbh && sth->dbh->driver == DBI_DRIVER_SQLITE && sth->stmt) {
        sqlite3_reset((sqlite3_stmt*)sth->stmt);
    }
#endif
#ifdef HAVE_MYSQL
    if (sth->dbh && sth->dbh->driver == DBI_DRIVER_MYSQL && sth->stmt) {
        mysql_stmt_free_result((MYSQL_STMT*)sth->stmt);
    }
#endif
}

/* Free statement */
static void dbi_free_statement(DbiStatement *sth) {
    if (!sth) return;

    if (sth->dbh) {
        switch (sth->dbh->driver) {
#ifdef HAVE_SQLITE3
            case DBI_DRIVER_SQLITE:
                if (sth->stmt) sqlite3_finalize((sqlite3_stmt*)sth->stmt);
                break;
#endif
#ifdef HAVE_MYSQL
            case DBI_DRIVER_MYSQL:
                if (sth->stmt) mysql_stmt_close((MYSQL_STMT*)sth->stmt);
                break;
#endif
#ifdef HAVE_POSTGRES
            case DBI_DRIVER_POSTGRES:
                if (sth->result) PQclear((PGresult*)sth->result);
                break;
#endif
            default:
                break;
        }
    }

    free(sth->sql);
    if (sth->column_names) {
        for (int i = 0; i < sth->num_columns; i++) {
            free(sth->column_names[i]);
        }
        free(sth->column_names);
    }
    free(sth->column_types);

#ifdef HAVE_MYSQL
    /* Clean up MySQL result bindings */
    if (sth->mysql_buffers) {
        for (int i = 0; i < sth->num_columns; i++) {
            free(sth->mysql_buffers[i]);
        }
        free(sth->mysql_buffers);
    }
    free(sth->mysql_result_binds);
    free(sth->mysql_lengths);
    free(sth->mysql_nulls);
    free(sth->mysql_buffer_sizes);

    /* Clean up MySQL parameter bindings */
    if (sth->mysql_param_buffers) {
        for (int i = 0; i < sth->num_params; i++) {
            free(sth->mysql_param_buffers[i]);
        }
        free(sth->mysql_param_buffers);
    }
    free(sth->mysql_param_binds);
    free(sth->mysql_param_lengths);
    free(sth->mysql_param_nulls);
#endif

    free(sth);
}

/* Execute SQL directly */
static int dbi_do_sql(DbiHandle *dbh, const char *sql) {
    if (!dbh || !sql) return -1;
    DbiStatement *sth = dbi_prepare(dbh, sql);
    if (!sth) return -1;
    int result = dbi_execute_raw(sth);
    dbi_free_statement(sth);
    return result;
}

/* Transaction functions */
static int dbi_begin_work(DbiHandle *dbh) {
    if (!dbh || !dbh->connected) return -1;
    if (dbh->in_transaction) {
        dbi_set_error(dbh, -1, "Already in a transaction");
        return -1;
    }
    int rc = dbi_do_sql(dbh, "BEGIN");
    if (rc >= 0) dbh->in_transaction = 1;
    return rc;
}

static int dbi_commit(DbiHandle *dbh) {
    if (!dbh || !dbh->connected) return -1;
    int rc = dbi_do_sql(dbh, "COMMIT");
    dbh->in_transaction = 0;
    return rc;
}

static int dbi_rollback(DbiHandle *dbh) {
    if (!dbh || !dbh->connected) return -1;
    int rc = dbi_do_sql(dbh, "ROLLBACK");
    dbh->in_transaction = 0;
    return rc;
}

/* Quote string */
static char* dbi_quote(DbiHandle *dbh, const char *str) {
    if (!str) return strdup("NULL");
    size_t len = strlen(str);
    char *quoted = malloc(len * 2 + 3);
    char *p = quoted;
    *p++ = '\'';
    while (*str) {
        if (*str == '\'') {
            *p++ = '\'';
            *p++ = '\'';
        } else if (*str == '\\' && dbh && dbh->driver == DBI_DRIVER_MYSQL) {
            *p++ = '\\';
            *p++ = '\\';
        } else {
            *p++ = *str;
        }
        str++;
    }
    *p++ = '\'';
    *p = '\0';
    return quoted;
}

/* Get last insert ID */
static int64_t dbi_last_insert_id(DbiHandle *dbh) {
    if (!dbh || !dbh->connected) return -1;

    switch (dbh->driver) {
#ifdef HAVE_SQLITE3
        case DBI_DRIVER_SQLITE:
            return sqlite3_last_insert_rowid((sqlite3*)dbh->conn);
#endif
#ifdef HAVE_MYSQL
        case DBI_DRIVER_MYSQL:
            return mysql_insert_id((MYSQL*)dbh->conn);
#endif
#ifdef HAVE_POSTGRES
        case DBI_DRIVER_POSTGRES: {
            PGresult *res = PQexec((PGconn*)dbh->conn, "SELECT lastval()");
            if (PQresultStatus(res) == PGRES_TUPLES_OK && PQntuples(res) > 0) {
                int64_t id = strtoll(PQgetvalue(res, 0, 0), NULL, 10);
                PQclear(res);
                return id;
            }
            PQclear(res);
            return -1;
        }
#endif
        default:
            return -1;
    }
}

/* Get error message */
static const char* dbi_errstr(DbiHandle *dbh) {
    if (!dbh) return "No database handle";
    return dbh->error_msg ? dbh->error_msg : "";
}

/* Get error code */
static int dbi_err(DbiHandle *dbh) {
    if (!dbh) return -1;
    return dbh->error_code;
}

/* Get affected rows */
static int dbi_rows(DbiStatement *sth) {
    if (!sth) return -1;
    return sth->affected_rows;
}


/* Global command-line argument variables */
StradaValue *ARGV = NULL;
StradaValue *ARGC = NULL;

/* Global variables */
StradaValue *g_pass = NULL;
StradaValue *g_fail = NULL;

/* Qualified imports from DBI */

/* Qualified imports from Nesso */

/* Qualified imports from Nesso::Record */

StradaValue* DBI_connect(StradaValue* dsn, StradaValue* username, StradaValue* password);
StradaValue* DBI_connect_attrs(StradaValue* dsn, StradaValue* username, StradaValue* password, StradaValue* attrs);
void DBI_disconnect(StradaValue* dbh);
StradaValue* DBI_prepare(StradaValue* dbh, StradaValue* sql);
void DBI__bind_params(StradaValue* sth_ptr, StradaValue* params);
StradaValue* DBI_execute(StradaValue* sth, StradaValue* params);
StradaValue* DBI_exec(StradaValue* dbh, StradaValue* sql, StradaValue* params);
StradaValue* DBI_do_sql(StradaValue* dbh, StradaValue* sql);
StradaValue* DBI_fetchrow_array(StradaValue* sth);
StradaValue* DBI_fetchrow_hashref(StradaValue* sth);
StradaValue* DBI_fetchall_arrayref(StradaValue* sth);
StradaValue* DBI_selectall_arrayref(StradaValue* dbh, StradaValue* sql);
StradaValue* DBI_selectall_arrayref_bind(StradaValue* dbh, StradaValue* sql, StradaValue* params);
StradaValue* DBI_begin_work(StradaValue* dbh);
StradaValue* DBI_commit(StradaValue* dbh);
StradaValue* DBI_rollback(StradaValue* dbh);
StradaValue* DBI_quote(StradaValue* dbh, StradaValue* value);
StradaValue* DBI_last_insert_id(StradaValue* dbh);
StradaValue* DBI_errstr(StradaValue* dbh);
StradaValue* DBI_err(StradaValue* dbh);
void DBI_set_raise_error(StradaValue* dbh, StradaValue* flag);
void DBI_finish(StradaValue* sth);
StradaValue* DBI_rows(StradaValue* sth);
StradaValue* DBI_column_names(StradaValue* sth);
StradaValue* DBI_ping(StradaValue* dbh);
StradaValue* DBI_selectall_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params);
StradaValue* DBI_selectrow_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params);
StradaValue* DBI_selectcol(StradaValue* dbh, StradaValue* sql, StradaValue* params);
StradaValue* DBI_insert_get_id(StradaValue* dbh, StradaValue* sql, StradaValue* params);
void Nesso_log_sql(StradaValue* self, StradaValue* sql, StradaValue* params);
StradaValue* Nesso_get_schema(StradaValue* self, StradaValue* model);
StradaValue* Nesso_build_where_clause(StradaValue* self, StradaValue* conds, StradaValue* params);
StradaValue* Nesso_wrap_record(StradaValue* self, StradaValue* model, StradaValue* row);
StradaValue* Nesso_tag_rows(StradaValue* self, StradaValue* model, StradaValue* rows);
StradaValue* Nesso_new(StradaValue* dbh);
void Nesso_set_db(StradaValue* self, StradaValue* db);
StradaValue* Nesso_get_db(StradaValue* self);
void Nesso_set_debug(StradaValue* self, StradaValue* on);
StradaValue* Nesso_get_debug(StradaValue* self);
void Nesso_define(StradaValue* self, StradaValue* name, StradaValue* schema);
StradaValue* Nesso_columns(StradaValue* self, StradaValue* model);
StradaValue* Nesso_create(StradaValue* self, StradaValue* model, StradaValue* attrs);
StradaValue* Nesso_save(StradaValue* self, StradaValue* record);
StradaValue* Nesso_find(StradaValue* self, StradaValue* model, StradaValue* id);
StradaValue* Nesso_find_by(StradaValue* self, StradaValue* model, StradaValue* conds);
StradaValue* Nesso_where(StradaValue* self, StradaValue* model, StradaValue* conds);
StradaValue* Nesso_all(StradaValue* self, StradaValue* model);
StradaValue* Nesso_count(StradaValue* self, StradaValue* model, StradaValue* conds);
StradaValue* Nesso_delete(StradaValue* self, StradaValue* record);
StradaValue* Nesso_query(StradaValue* self, StradaValue* sql, StradaValue* params);
void Nesso_transaction(StradaValue* self, StradaValue* cb);
void Nesso_has_many(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* fk);
void Nesso_belongs_to(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk);
void Nesso_has_one(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk);
StradaValue* Nesso_related(StradaValue* self, StradaValue* record, StradaValue* name);
StradaValue* Nesso_clone(StradaValue* self, StradaValue* new_dbh);
StradaValue* Nesso_Record_save(StradaValue* self);
StradaValue* Nesso_Record_update(StradaValue* self, StradaValue* attrs);
StradaValue* Nesso_Record_delete(StradaValue* self);
StradaValue* Nesso_Record_reload(StradaValue* self);
StradaValue* Nesso_Record_related(StradaValue* self, StradaValue* name);
StradaValue* Nesso_Record_model(StradaValue* self);
StradaValue* Nesso_Record_id(StradaValue* self);
StradaValue* Nesso_Record_is_new(StradaValue* self);
StradaValue* AdminUser_is_super_admin(StradaValue* self);
void AdminUser_promote(StradaValue* self);
void ok(StradaValue* cond, StradaValue* msg);
int main(int _argc, char **_argv);


/* OOP method registration forward declarations */
void __DBI_oop_init(void);
void __Nesso_oop_init(void);
void __Nesso_Record_oop_init(void);
void __AdminUser_oop_init(void);
/* Anonymous function forward declarations */
StradaValue* __anon_func_0(StradaValue ***__captures);
StradaValue* __anon_func_1(StradaValue ***__captures);

StradaValue* DBI_connect(StradaValue* dsn, StradaValue* username, StradaValue* password) {
strada_incref(dsn);
strada_incref(username);
strada_incref(password);
#line 2486 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_new_int(0);
/* Begin __C__ block */

        char *dsn_str = strada_to_str(dsn);
        char *user_str = strada_to_str(username);
        char *pass_str = strada_to_str(password);
        DbiHandle *dbh = dbi_connect_raw(dsn_str, user_str, pass_str, 1, 1);
        strada_decref(dbh_ptr);  /* Free old value before reassign */
        dbh_ptr = strada_new_int((int64_t)(intptr_t)dbh);
        free(dsn_str);
        free(user_str);
        free(pass_str);
    
/* End __C__ block */
if ((strada_to_num(dbh_ptr) == 0.0)) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(dbh_ptr);
        strada_decref(dsn);
        strada_decref(username);
        strada_decref(password);
        return __retval; }
}
#line 2513 "lib/Nesso/test_nesso.strada"
StradaValue *handle = strada_new_hash();
strada_hash_set(strada_deref_hash(handle), "_ptr", dbh_ptr);
strada_hash_set(strada_deref_hash(handle), "dsn", dsn);
{ StradaValue *__retval = strada_new_ref(handle, '%');
    strada_decref(dbh_ptr);
    strada_decref(handle);
    strada_decref(dsn);
    strada_decref(username);
    strada_decref(password);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(handle);
}


StradaValue* DBI_connect_attrs(StradaValue* dsn, StradaValue* username, StradaValue* password, StradaValue* attrs) {
strada_incref(dsn);
strada_incref(username);
strada_incref(password);
strada_incref(attrs);
#line 2521 "lib/Nesso/test_nesso.strada"
StradaValue *auto_commit = strada_new_int(1);
#line 2522 "lib/Nesso/test_nesso.strada"
StradaValue *print_error = strada_new_int(1);
#line 2523 "lib/Nesso/test_nesso.strada"
StradaValue *raise_error = strada_new_int(0);
if (strada_defined_bool(attrs)) {
    if (strada_defined_bool(strada_hash_get(strada_deref_hash(attrs), "AutoCommit"))) {
        ({ StradaValue *__old = auto_commit; auto_commit = strada_hash_get(strada_deref_hash(attrs), "AutoCommit"); strada_incref(auto_commit); strada_decref(__old); auto_commit; });
    }
    if (strada_defined_bool(strada_hash_get(strada_deref_hash(attrs), "PrintError"))) {
        ({ StradaValue *__old = print_error; print_error = strada_hash_get(strada_deref_hash(attrs), "PrintError"); strada_incref(print_error); strada_decref(__old); print_error; });
    }
    if (strada_defined_bool(strada_hash_get(strada_deref_hash(attrs), "RaiseError"))) {
        ({ StradaValue *__old = raise_error; raise_error = strada_hash_get(strada_deref_hash(attrs), "RaiseError"); strada_incref(raise_error); strada_decref(__old); raise_error; });
    }
}
#line 2537 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_new_int(0);
/* Begin __C__ block */

        char *dsn_str = strada_to_str(dsn);
        char *user_str = strada_to_str(username);
        char *pass_str = strada_to_str(password);
        int ac = (int)strada_to_int(auto_commit);
        int pe = (int)strada_to_int(print_error);
        DbiHandle *dbh = dbi_connect_raw(dsn_str, user_str, pass_str, ac, pe);
        if (dbh) {
            dbh->raise_error = (int)strada_to_int(raise_error);
        }
        strada_decref(dbh_ptr);  /* Free old value before reassign */
        dbh_ptr = strada_new_int((int64_t)(intptr_t)dbh);
        free(dsn_str);
        free(user_str);
        free(pass_str);
    
/* End __C__ block */
if ((strada_to_num(dbh_ptr) == 0.0)) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(auto_commit);
        strada_decref(print_error);
        strada_decref(raise_error);
        strada_decref(dbh_ptr);
        strada_decref(dsn);
        strada_decref(username);
        strada_decref(password);
        strada_decref(attrs);
        return __retval; }
}
#line 2574 "lib/Nesso/test_nesso.strada"
StradaValue *handle = strada_new_hash();
strada_hash_set(strada_deref_hash(handle), "_ptr", dbh_ptr);
strada_hash_set(strada_deref_hash(handle), "dsn", dsn);
{ StradaValue *__retval = strada_new_ref(handle, '%');
    strada_decref(auto_commit);
    strada_decref(print_error);
    strada_decref(raise_error);
    strada_decref(dbh_ptr);
    strada_decref(handle);
    strada_decref(dsn);
    strada_decref(username);
    strada_decref(password);
    strada_decref(attrs);
    return __retval; }
strada_decref(auto_commit);
strada_decref(print_error);
strada_decref(raise_error);
strada_decref(dbh_ptr);
strada_decref(handle);
}


void DBI_disconnect(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    strada_decref(dbh);
    return;
}
#line 2585 "lib/Nesso/test_nesso.strada"
StradaValue *handle = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(handle);
if ((strada_to_num(handle) != 0.0)) {
/* Begin __C__ block */

            DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(handle);
            dbi_disconnect(h);
        
/* End __C__ block */
}
strada_decref(handle);
strada_decref(dbh);
}


StradaValue* DBI_prepare(StradaValue* dbh, StradaValue* sql) {
strada_incref(dbh);
strada_incref(sql);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(dbh);
        strada_decref(sql);
        return __retval; }
}
#line 2603 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 2604 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        char *sql_str = strada_to_str(sql);
        DbiStatement *sth = dbi_prepare(h, sql_str);
        strada_decref(sth_ptr);  /* Free old value before reassign */
        sth_ptr = strada_new_int((int64_t)(intptr_t)sth);
        free(sql_str);
    
/* End __C__ block */
if ((strada_to_num(sth_ptr) == 0.0)) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(dbh_ptr);
        strada_decref(sth_ptr);
        strada_decref(dbh);
        strada_decref(sql);
        return __retval; }
}
#line 2626 "lib/Nesso/test_nesso.strada"
StradaValue *handle = strada_new_hash();
strada_hash_set(strada_deref_hash(handle), "_ptr", sth_ptr);
strada_hash_set(strada_deref_hash(handle), "_dbh", dbh);
strada_hash_set(strada_deref_hash(handle), "sql", sql);
({ StradaValue *__hset_v = strada_new_int(0); strada_hash_set(strada_deref_hash(handle), "_executed", __hset_v); strada_decref(__hset_v); });
{ StradaValue *__retval = strada_new_ref(handle, '%');
    strada_decref(dbh_ptr);
    strada_decref(sth_ptr);
    strada_decref(handle);
    strada_decref(dbh);
    strada_decref(sql);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(sth_ptr);
strada_decref(handle);
}


void DBI__bind_params(StradaValue* sth_ptr, StradaValue* params) {
strada_incref(sth_ptr);
strada_incref(params);
if (!(strada_defined_bool(params))) {
    strada_decref(sth_ptr);
    strada_decref(params);
    return;
}
#line 2641 "lib/Nesso/test_nesso.strada"
StradaValue *count = strada_new_int(strada_array_length(strada_deref_array(params)));
#line 2642 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(count))) {
#line 2644 "lib/Nesso/test_nesso.strada"
    StradaValue *val = strada_array_get(strada_deref_array(params), strada_to_int(i)); strada_incref(val);
#line 2645 "lib/Nesso/test_nesso.strada"
    StradaValue *idx = strada_new_num(strada_to_num(i) + 1.0);
    if (!(strada_defined_bool(val))) {
/* Begin __C__ block */

                DbiStatement *sth = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
                int index = (int)strada_to_int(idx);
                dbi_bind_null(sth, index);
            
/* End __C__ block */
    } else {
/* Begin __C__ block */

                DbiStatement *sth = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
                int index = (int)strada_to_int(idx);
                dbi_bind_value(sth, index, val);
            
/* End __C__ block */
    }
    ({ StradaValue *__old = i; i = strada_new_num(strada_to_num(i) + 1.0); strada_decref(__old); i; });
    strada_decref(val);
    strada_decref(idx);
}
strada_decref(count);
strada_decref(i);
strada_decref(sth_ptr);
strada_decref(params);
}


StradaValue* DBI_execute(StradaValue* sth, StradaValue* params) {
strada_incref(sth);
strada_incref(params);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(sth);
        strada_decref(params);
        return __retval; }
}
#line 2679 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
/* Begin __C__ block */

        DbiStatement *s = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        dbi_clear_bindings(s);
    
/* End __C__ block */
DBI__bind_params(sth_ptr, params);
#line 2691 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiStatement *s2 = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        strada_decref(result);  /* Free old value before reassign */
        result = strada_new_int(dbi_execute_raw(s2));
    
/* End __C__ block */
({ StradaValue *__hset_v = strada_new_int(1); strada_hash_set(strada_deref_hash(sth), "_executed", __hset_v); strada_decref(__hset_v); });
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(sth_ptr);
    strada_decref(result);
    strada_decref(sth);
    strada_decref(params);
    return __retval; }
strada_decref(sth_ptr);
strada_decref(result);
}


StradaValue* DBI_exec(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 2707 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
#line 2712 "lib/Nesso/test_nesso.strada"
StradaValue *result = DBI_execute(sth, params);
DBI_finish(sth);
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(sth);
    strada_decref(result);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(sth);
strada_decref(result);
}


StradaValue* DBI_do_sql(StradaValue* dbh, StradaValue* sql) {
strada_incref(dbh);
strada_incref(sql);
{ StradaValue *__retval = ({ StradaValue *__arg2 = strada_anon_array(0); StradaValue *__call_result = DBI_exec(dbh, sql, __arg2); strada_decref(__arg2); __call_result; });
    strada_decref(dbh);
    strada_decref(sql);
    return __retval; }
}


StradaValue* DBI_fetchrow_array(StradaValue* sth) {
strada_incref(sth);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        return __retval; }
}
#line 2728 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
#line 2729 "lib/Nesso/test_nesso.strada"
StradaValue *rc = strada_new_int(0);
#line 2730 "lib/Nesso/test_nesso.strada"
StradaValue *col_count = strada_new_int(0);
/* Begin __C__ block */

        DbiStatement *s = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        strada_decref(rc);
        strada_decref(col_count);
        rc = strada_new_int(dbi_step(s));
        col_count = strada_new_int(dbi_column_count(s));
    
/* End __C__ block */
if ((strada_to_num(rc) != 1.0)) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth_ptr);
        strada_decref(rc);
        strada_decref(col_count);
        strada_decref(sth);
        return __retval; }
}
#line 2750 "lib/Nesso/test_nesso.strada"
StradaValue *row = strada_new_array();
#line 2751 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(col_count))) {
#line 2753 "lib/Nesso/test_nesso.strada"
    StradaValue *is_null = strada_new_int(0);
#line 2754 "lib/Nesso/test_nesso.strada"
    StradaValue *col_type = strada_new_int(0);
#line 2755 "lib/Nesso/test_nesso.strada"
    StradaValue *int_val = strada_new_int(0);
#line 2756 "lib/Nesso/test_nesso.strada"
    StradaValue *num_val = strada_new_num(0.0);
#line 2757 "lib/Nesso/test_nesso.strada"
    StradaValue *str_val = strada_new_str("");
/* Begin __C__ block */

            DbiStatement *s = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
            int idx = (int)strada_to_int(i);
            strada_decref(is_null);
            strada_decref(col_type);
            strada_decref(int_val);
            strada_decref(num_val);
            strada_decref(str_val);
            is_null = strada_new_int(dbi_column_is_null(s, idx));
            col_type = strada_new_int(dbi_column_type(s, idx));
            int_val = strada_new_int(dbi_column_int(s, idx));
            num_val = strada_new_num(dbi_column_num(s, idx));
            char *str = dbi_column_str(s, idx);
            str_val = strada_new_str(str);
            free(str);
        
/* End __C__ block */
    if ((strada_to_num(is_null) == 1.0)) {
        ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(row), strada_new_undef()), strada_undef_static()); strada_decref(__expr_tmp); });
    } else if ((strada_to_num(col_type) == 1.0)) {
        ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(row), int_val), strada_undef_static()); strada_decref(__expr_tmp); });
    } else if ((strada_to_num(col_type) == 2.0)) {
        ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(row), num_val), strada_undef_static()); strada_decref(__expr_tmp); });
    } else {
        ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(row), str_val), strada_undef_static()); strada_decref(__expr_tmp); });
    }
    ({ StradaValue *__old = i; i = strada_new_num(strada_to_num(i) + 1.0); strada_decref(__old); i; });
    strada_decref(is_null);
    strada_decref(col_type);
    strada_decref(int_val);
    strada_decref(num_val);
    strada_decref(str_val);
}
{ StradaValue *__retval = strada_new_ref(row, '@');
    strada_decref(sth_ptr);
    strada_decref(rc);
    strada_decref(col_count);
    strada_decref(row);
    strada_decref(i);
    strada_decref(sth);
    return __retval; }
strada_decref(sth_ptr);
strada_decref(rc);
strada_decref(col_count);
strada_decref(row);
strada_decref(i);
}


StradaValue* DBI_fetchrow_hashref(StradaValue* sth) {
strada_incref(sth);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        return __retval; }
}
#line 2812 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
#line 2813 "lib/Nesso/test_nesso.strada"
StradaValue *rc = strada_new_int(0);
#line 2814 "lib/Nesso/test_nesso.strada"
StradaValue *col_count = strada_new_int(0);
/* Begin __C__ block */

        DbiStatement *s = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        strada_decref(rc);
        strada_decref(col_count);
        rc = strada_new_int(dbi_step(s));
        col_count = strada_new_int(dbi_column_count(s));
    
/* End __C__ block */
if ((strada_to_num(rc) != 1.0)) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth_ptr);
        strada_decref(rc);
        strada_decref(col_count);
        strada_decref(sth);
        return __retval; }
}
#line 2834 "lib/Nesso/test_nesso.strada"
StradaValue *row = strada_new_hash();
#line 2835 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(col_count))) {
#line 2837 "lib/Nesso/test_nesso.strada"
    StradaValue *name = strada_new_str("");
#line 2838 "lib/Nesso/test_nesso.strada"
    StradaValue *is_null = strada_new_int(0);
#line 2839 "lib/Nesso/test_nesso.strada"
    StradaValue *col_type = strada_new_int(0);
#line 2840 "lib/Nesso/test_nesso.strada"
    StradaValue *int_val = strada_new_int(0);
#line 2841 "lib/Nesso/test_nesso.strada"
    StradaValue *num_val = strada_new_num(0.0);
#line 2842 "lib/Nesso/test_nesso.strada"
    StradaValue *str_val = strada_new_str("");
/* Begin __C__ block */

            DbiStatement *s = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
            int idx = (int)strada_to_int(i);
            strada_decref(name);
            strada_decref(is_null);
            strada_decref(col_type);
            strada_decref(int_val);
            strada_decref(num_val);
            strada_decref(str_val);
            char *n = dbi_column_name(s, idx);
            name = strada_new_str(n);
            free(n);
            is_null = strada_new_int(dbi_column_is_null(s, idx));
            col_type = strada_new_int(dbi_column_type(s, idx));
            int_val = strada_new_int(dbi_column_int(s, idx));
            num_val = strada_new_num(dbi_column_num(s, idx));
            char *str = dbi_column_str(s, idx);
            str_val = strada_new_str(str);
            free(str);
        
/* End __C__ block */
    if ((strada_to_num(is_null) == 1.0)) {
        ({ StradaValue *__hset_k = name; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(row), __hset_ks, strada_new_undef()); free(__hset_ks); });
    } else if ((strada_to_num(col_type) == 1.0)) {
        ({ StradaValue *__hset_k = name; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(row), __hset_ks, int_val); free(__hset_ks); });
    } else if ((strada_to_num(col_type) == 2.0)) {
        ({ StradaValue *__hset_k = name; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(row), __hset_ks, num_val); free(__hset_ks); });
    } else {
        ({ StradaValue *__hset_k = name; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(row), __hset_ks, str_val); free(__hset_ks); });
    }
    ({ StradaValue *__old = i; i = strada_new_num(strada_to_num(i) + 1.0); strada_decref(__old); i; });
    strada_decref(name);
    strada_decref(is_null);
    strada_decref(col_type);
    strada_decref(int_val);
    strada_decref(num_val);
    strada_decref(str_val);
}
{ StradaValue *__retval = strada_new_ref(row, '%');
    strada_decref(sth_ptr);
    strada_decref(rc);
    strada_decref(col_count);
    strada_decref(row);
    strada_decref(i);
    strada_decref(sth);
    return __retval; }
strada_decref(sth_ptr);
strada_decref(rc);
strada_decref(col_count);
strada_decref(row);
strada_decref(i);
}


StradaValue* DBI_fetchall_arrayref(StradaValue* sth) {
strada_incref(sth);
#line 2901 "lib/Nesso/test_nesso.strada"
StradaValue *all = strada_new_array();
#line 2902 "lib/Nesso/test_nesso.strada"
StradaValue *row = DBI_fetchrow_array(sth);
while (strada_defined_bool(row)) {
    ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(all), row), strada_undef_static()); strada_decref(__expr_tmp); });
    ({ StradaValue *__old = row; row = DBI_fetchrow_array(sth); strada_decref(__old); row; });
}
{ StradaValue *__retval = strada_new_ref(all, '@');
    strada_decref(all);
    strada_decref(row);
    strada_decref(sth);
    return __retval; }
strada_decref(all);
strada_decref(row);
}


StradaValue* DBI_selectall_arrayref(StradaValue* dbh, StradaValue* sql) {
strada_incref(dbh);
strada_incref(sql);
#line 2914 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        return __retval; }
}
#line 2918 "lib/Nesso/test_nesso.strada"
StradaValue *empty = strada_new_array();
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_ref(empty, '@'); StradaValue *__call_result = DBI_execute(sth, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
{ StradaValue *__retval = DBI_fetchall_arrayref(sth);
    strada_decref(sth);
    strada_decref(empty);
    strada_decref(dbh);
    strada_decref(sql);
    return __retval; }
strada_decref(sth);
strada_decref(empty);
}


StradaValue* DBI_selectall_arrayref_bind(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 2925 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
({ StradaValue *__expr_tmp = DBI_execute(sth, params); strada_decref(__expr_tmp); });
{ StradaValue *__retval = DBI_fetchall_arrayref(sth);
    strada_decref(sth);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(sth);
}


StradaValue* DBI_begin_work(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(dbh);
        return __retval; }
}
#line 2938 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 2939 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_begin_work(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_commit(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(dbh);
        return __retval; }
}
#line 2957 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 2958 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_commit(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_rollback(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(dbh);
        return __retval; }
}
#line 2976 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 2977 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_rollback(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_quote(StradaValue* dbh, StradaValue* value) {
strada_incref(dbh);
strada_incref(value);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_str("''");
        strada_decref(dbh);
        strada_decref(value);
        return __retval; }
}
#line 2996 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 2997 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_str("");
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        char *val_str = strada_to_str(value);
        char *quoted = dbi_quote(h, val_str);
        strada_decref(result);
        result = strada_new_str(quoted);
        free(quoted);
        free(val_str);
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    strada_decref(value);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_last_insert_id(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(dbh);
        return __retval; }
}
#line 3023 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 3024 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_last_insert_id(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_errstr(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_str("No database handle");
        strada_decref(dbh);
        return __retval; }
}
#line 3043 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 3044 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_str("");
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_str(dbi_errstr(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_err(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(dbh);
        return __retval; }
}
#line 3062 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 3063 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_err(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


void DBI_set_raise_error(StradaValue* dbh, StradaValue* flag) {
strada_incref(dbh);
strada_incref(flag);
if (!(strada_defined_bool(dbh))) {
    strada_decref(dbh);
    strada_decref(flag);
    return;
}
#line 3081 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        dbi_set_raise_error(h, (int)strada_to_int(flag));
    
/* End __C__ block */
strada_decref(dbh_ptr);
strada_decref(dbh);
strada_decref(flag);
}


void DBI_finish(StradaValue* sth) {
strada_incref(sth);
if (!(strada_defined_bool(sth))) {
    strada_decref(sth);
    return;
}
#line 3096 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
if ((strada_to_num(sth_ptr) == 0.0)) {
    strada_decref(sth_ptr);
    strada_decref(sth);
    return;
}
/* Begin __C__ block */

        DbiStatement *stmt = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        dbi_finish(stmt);
        dbi_free_statement(stmt);
    
/* End __C__ block */
({ StradaValue *__hset_v = strada_new_int(0); strada_hash_set(strada_deref_hash(sth), "_ptr", __hset_v); strada_decref(__hset_v); });
strada_decref(sth_ptr);
strada_decref(sth);
}


StradaValue* DBI_rows(StradaValue* sth) {
strada_incref(sth);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(sth);
        return __retval; }
}
#line 3118 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
#line 3119 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiStatement *stmt = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_rows(stmt));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(sth_ptr);
    strada_decref(result);
    strada_decref(sth);
    return __retval; }
strada_decref(sth_ptr);
strada_decref(result);
}


StradaValue* DBI_column_names(StradaValue* sth) {
strada_incref(sth);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_anon_array(0);
        strada_decref(sth);
        return __retval; }
}
#line 3138 "lib/Nesso/test_nesso.strada"
StradaValue *sth_ptr = strada_hash_get(strada_deref_hash(sth), "_ptr"); strada_incref(sth_ptr);
#line 3139 "lib/Nesso/test_nesso.strada"
StradaValue *col_count = strada_new_int(0);
/* Begin __C__ block */

        DbiStatement *stmt = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
        strada_decref(col_count);
        col_count = strada_new_int(dbi_column_count(stmt));
    
/* End __C__ block */
#line 3150 "lib/Nesso/test_nesso.strada"
StradaValue *names = strada_new_array();
#line 3151 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(col_count))) {
#line 3153 "lib/Nesso/test_nesso.strada"
    StradaValue *name = strada_new_str("");
/* Begin __C__ block */

            DbiStatement *stmt = (DbiStatement *)(intptr_t)strada_to_int(sth_ptr);
            int idx = (int)strada_to_int(i);
            char *n = dbi_column_name(stmt, idx);
            strada_decref(name);
            name = strada_new_str(n);
            free(n);
        
/* End __C__ block */
    ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(names), name), strada_undef_static()); strada_decref(__expr_tmp); });
    ({ StradaValue *__old = i; i = strada_new_num(strada_to_num(i) + 1.0); strada_decref(__old); i; });
    strada_decref(name);
}
{ StradaValue *__retval = strada_new_ref(names, '@');
    strada_decref(sth_ptr);
    strada_decref(col_count);
    strada_decref(names);
    strada_decref(i);
    strada_decref(sth);
    return __retval; }
strada_decref(sth_ptr);
strada_decref(col_count);
strada_decref(names);
strada_decref(i);
}


StradaValue* DBI_ping(StradaValue* dbh) {
strada_incref(dbh);
if (!(strada_defined_bool(dbh))) {
    { StradaValue *__retval = strada_new_int(0);
        strada_decref(dbh);
        return __retval; }
}
#line 3181 "lib/Nesso/test_nesso.strada"
StradaValue *dbh_ptr = strada_hash_get(strada_deref_hash(dbh), "_ptr"); strada_incref(dbh_ptr);
#line 3182 "lib/Nesso/test_nesso.strada"
StradaValue *result = strada_new_int(0);
/* Begin __C__ block */

        DbiHandle *h = (DbiHandle *)(intptr_t)strada_to_int(dbh_ptr);
        strada_decref(result);
        result = strada_new_int(dbi_ping(h));
    
/* End __C__ block */
{ StradaValue *__retval = result;
    strada_incref(__retval);
    strada_decref(dbh_ptr);
    strada_decref(result);
    strada_decref(dbh);
    return __retval; }
strada_decref(dbh_ptr);
strada_decref(result);
}


StradaValue* DBI_selectall_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 3201 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_anon_array(0);
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
({ StradaValue *__expr_tmp = DBI_execute(sth, params); strada_decref(__expr_tmp); });
#line 3208 "lib/Nesso/test_nesso.strada"
StradaValue *results = strada_new_array();
#line 3209 "lib/Nesso/test_nesso.strada"
StradaValue *row = DBI_fetchrow_hashref(sth);
while (strada_defined_bool(row)) {
    ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(results), row), strada_undef_static()); strada_decref(__expr_tmp); });
    ({ StradaValue *__old = row; row = DBI_fetchrow_hashref(sth); strada_decref(__old); row; });
}
DBI_finish(sth);
{ StradaValue *__retval = strada_new_ref(results, '@');
    strada_decref(sth);
    strada_decref(results);
    strada_decref(row);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(sth);
strada_decref(results);
strada_decref(row);
}


StradaValue* DBI_selectrow_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 3221 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
({ StradaValue *__expr_tmp = DBI_execute(sth, params); strada_decref(__expr_tmp); });
#line 3227 "lib/Nesso/test_nesso.strada"
StradaValue *row = DBI_fetchrow_hashref(sth);
DBI_finish(sth);
{ StradaValue *__retval = row;
    strada_incref(__retval);
    strada_decref(sth);
    strada_decref(row);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(sth);
strada_decref(row);
}


StradaValue* DBI_selectcol(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 3234 "lib/Nesso/test_nesso.strada"
StradaValue *sth = DBI_prepare(dbh, sql);
if (!(strada_defined_bool(sth))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(sth);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
({ StradaValue *__expr_tmp = DBI_execute(sth, params); strada_decref(__expr_tmp); });
#line 3240 "lib/Nesso/test_nesso.strada"
StradaValue *row = DBI_fetchrow_array(sth);
DBI_finish(sth);
if ((strada_defined_bool(row) && (({ StradaValue *__num_tmp = strada_new_int(strada_array_length(strada_deref_array(row))); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) > 0.0))) {
    { StradaValue *__retval = strada_array_get(strada_deref_array(row), 0);
        strada_incref(__retval);
        strada_decref(sth);
        strada_decref(row);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
{ StradaValue *__retval = strada_new_undef();
    strada_decref(sth);
    strada_decref(row);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(sth);
strada_decref(row);
}


StradaValue* DBI_insert_get_id(StradaValue* dbh, StradaValue* sql, StradaValue* params) {
strada_incref(dbh);
strada_incref(sql);
strada_incref(params);
#line 3251 "lib/Nesso/test_nesso.strada"
StradaValue *result = DBI_exec(dbh, sql, params);
if ((strada_to_num(result) < 0.0)) {
    { StradaValue *__retval = strada_new_num(-strada_to_num(strada_new_int(1)));
        strada_decref(result);
        strada_decref(dbh);
        strada_decref(sql);
        strada_decref(params);
        return __retval; }
}
{ StradaValue *__retval = DBI_last_insert_id(dbh);
    strada_decref(result);
    strada_decref(dbh);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(result);
}


void Nesso_log_sql(StradaValue* self, StradaValue* sql, StradaValue* params) {
strada_incref(self);
strada_incref(sql);
strada_incref(params);
if (strada_to_bool(strada_hash_get(strada_deref_hash(self), "_debug"))) {
    ({ StradaValue *__say_tmp = ({ StradaValue *__concat_l = strada_new_str("[Nesso] SQL: "); StradaValue *__concat_res = strada_concat_sv(__concat_l, sql); strada_decref(__concat_l); __concat_res; }); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 91 "lib/Nesso/test_nesso.strada"
    StradaValue *param_str = strada_new_str("");
#line 92 "lib/Nesso/test_nesso.strada"
    StradaValue *n = strada_new_int(strada_size(params));
#line 93 "lib/Nesso/test_nesso.strada"
    StradaValue *i = strada_new_int(0);
    while ((strada_to_num(i) < strada_to_num(n))) {
        if ((strada_to_num(i) > 0.0)) {
            ({ StradaValue *__old = param_str; param_str = ({ StradaValue *__concat_r = strada_new_str(", "); StradaValue *__concat_res = strada_concat_sv(param_str, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); param_str; });
        }
#line 98 "lib/Nesso/test_nesso.strada"
        StradaValue *p = strada_array_get(strada_deref_array(params), strada_to_int(i)); strada_incref(p);
        if (strada_defined_bool(p)) {
            ({ StradaValue *__old = param_str; param_str = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str("\""); StradaValue *__concat_res = strada_concat_sv(param_str, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, p); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("\""); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); param_str; });
        } else {
            ({ StradaValue *__old = param_str; param_str = ({ StradaValue *__concat_r = strada_new_str("NULL"); StradaValue *__concat_res = strada_concat_sv(param_str, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); param_str; });
        }
        ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
        strada_decref(p);
    }
    ({ StradaValue *__say_tmp = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("[Nesso] PARAMS: ["); StradaValue *__concat_res = strada_concat_sv(__concat_l, param_str); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("]"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_say(__say_tmp); strada_decref(__say_tmp); });
    strada_decref(param_str);
    strada_decref(n);
    strada_decref(i);
}
strada_decref(self);
strada_decref(sql);
strada_decref(params);
}


StradaValue* Nesso_get_schema(StradaValue* self, StradaValue* model) {
strada_incref(self);
strada_incref(model);
#line 112 "lib/Nesso/test_nesso.strada"
StradaValue *schema = ({ StradaValue *__hget_k = model; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_models")), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(schema);
if (!(strada_defined_bool(schema))) {
    strada_throw_value(({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("Nesso: unknown model '"); StradaValue *__concat_res = strada_concat_sv(__concat_l, model); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("'"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }));
}
{ StradaValue *__retval = schema;
    strada_incref(__retval);
    strada_decref(schema);
    strada_decref(self);
    strada_decref(model);
    return __retval; }
strada_decref(schema);
}


StradaValue* Nesso_build_where_clause(StradaValue* self, StradaValue* conds, StradaValue* params) {
strada_incref(self);
strada_incref(conds);
strada_incref(params);
#line 121 "lib/Nesso/test_nesso.strada"
StradaValue *cond_keys = strada_new_array_from_av(strada_hash_keys(strada_deref_hash(conds)));
#line 122 "lib/Nesso/test_nesso.strada"
StradaValue *where = strada_new_str("");
#line 123 "lib/Nesso/test_nesso.strada"
StradaValue *first = strada_new_int(1);
#line 124 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
#line 125 "lib/Nesso/test_nesso.strada"
StradaValue *nkeys = strada_new_int(strada_array_length(strada_deref_array(cond_keys)));
while ((strada_to_num(i) < strada_to_num(nkeys))) {
#line 127 "lib/Nesso/test_nesso.strada"
    StradaValue *key = strada_array_get(strada_deref_array(cond_keys), strada_to_int(i)); strada_incref(key);
    if (({ StradaValue *__cond_tmp = ({ StradaValue *__cmp_l = strada_substr(key, 0, 1); int __cmp_r = strada_str_ne_lit(__cmp_l, "_"); strada_decref(__cmp_l); strada_new_int(__cmp_r); }); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
        if ((strada_to_num(first) == 0.0)) {
            ({ StradaValue *__old = where; where = ({ StradaValue *__concat_r = strada_new_str(" AND "); StradaValue *__concat_res = strada_concat_sv(where, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); where; });
        }
        ({ StradaValue *__old = where; where = ({ StradaValue *__concat_l = strada_concat_sv(where, key); StradaValue *__concat_r = strada_new_str(" = ?"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); where; });
        ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(strada_deref_array_value(params)), ({ StradaValue *__hget_k = key; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(conds), __hget_ks); free(__hget_ks); __hget_r; })), strada_undef_static()); strada_decref(__expr_tmp); });
        ({ StradaValue *__old = first; first = strada_new_int(0); strada_decref(__old); first; });
    }
    ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
    strada_decref(key);
}
{ StradaValue *__retval = where;
    strada_incref(__retval);
    strada_decref(cond_keys);
    strada_decref(where);
    strada_decref(first);
    strada_decref(i);
    strada_decref(nkeys);
    strada_decref(self);
    strada_decref(conds);
    strada_decref(params);
    return __retval; }
strada_decref(cond_keys);
strada_decref(where);
strada_decref(first);
strada_decref(i);
strada_decref(nkeys);
}


StradaValue* Nesso_wrap_record(StradaValue* self, StradaValue* model, StradaValue* row) {
strada_incref(self);
strada_incref(model);
strada_incref(row);
if (!(strada_defined_bool(row))) {
    { StradaValue *__retval = strada_new_undef();
        strada_decref(self);
        strada_decref(model);
        strada_decref(row);
        return __retval; }
}
strada_hash_set(strada_deref_hash(row), "_model", model);
strada_hash_set(strada_deref_hash(row), "_nesso", self);
#line 151 "lib/Nesso/test_nesso.strada"
StradaValue *schema = ({ StradaValue *__hget_k = model; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_models")), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(schema);
#line 152 "lib/Nesso/test_nesso.strada"
StradaValue *class = strada_new_str("Nesso::Record");
if ((strada_defined_bool(schema) && strada_defined_bool(strada_hash_get(strada_deref_hash(schema), "class")))) {
    ({ StradaValue *__old = class; class = strada_hash_get(strada_deref_hash(schema), "class"); strada_incref(class); strada_decref(__old); class; });
}
{ StradaValue *__retval = ({ StradaValue *__bless_tmp = class; char *__bless_ps = strada_to_str(__bless_tmp); StradaValue *__bless_r = strada_bless(row, __bless_ps); free(__bless_ps); __bless_r; });
    strada_incref(__retval);
    strada_decref(schema);
    strada_decref(class);
    strada_decref(self);
    strada_decref(model);
    strada_decref(row);
    return __retval; }
strada_decref(schema);
strada_decref(class);
}


StradaValue* Nesso_tag_rows(StradaValue* self, StradaValue* model, StradaValue* rows) {
strada_incref(self);
strada_incref(model);
strada_incref(rows);
if (!(strada_defined_bool(rows))) {
    { StradaValue *__retval = strada_anon_array(0);
        strada_decref(self);
        strada_decref(model);
        strada_decref(rows);
        return __retval; }
}
#line 165 "lib/Nesso/test_nesso.strada"
StradaValue *nrows = strada_new_int(strada_size(rows));
#line 166 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(nrows))) {
    strada_array_set(strada_deref_array(rows), strada_to_int(i), strada_method_call(self, "wrap_record", strada_pack_args(2, model, strada_array_get(strada_deref_array(rows), strada_to_int(i)))));
    ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
}
{ StradaValue *__retval = rows;
    strada_incref(__retval);
    strada_decref(nrows);
    strada_decref(i);
    strada_decref(self);
    strada_decref(model);
    strada_decref(rows);
    return __retval; }
strada_decref(nrows);
strada_decref(i);
}


StradaValue* Nesso_new(StradaValue* dbh) {
strada_incref(dbh);
#line 178 "lib/Nesso/test_nesso.strada"
StradaValue *self = strada_new_hash();
strada_hash_set(strada_deref_hash(self), "_dbh", dbh);
({ StradaValue *__hset_v = strada_new_hash(); strada_hash_set(strada_deref_hash(self), "_models", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__hset_v = strada_new_hash(); strada_hash_set(strada_deref_hash(self), "_relations", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__hset_v = strada_new_int(0); strada_hash_set(strada_deref_hash(self), "_debug", __hset_v); strada_decref(__hset_v); });
{ StradaValue *__retval = strada_bless(strada_new_ref(self, '%'), "Nesso");
    strada_decref(self);
    strada_decref(dbh);
    return __retval; }
strada_decref(self);
}


void Nesso_set_db(StradaValue* self, StradaValue* db) {
strada_incref(self);
strada_incref(db);
strada_hash_set(strada_deref_hash(self), "_dbh", db);
strada_decref(self);
strada_decref(db);
}


StradaValue* Nesso_get_db(StradaValue* self) {
strada_incref(self);
{ StradaValue *__retval = strada_hash_get(strada_deref_hash(self), "_dbh");
    strada_incref(__retval);
    strada_decref(self);
    return __retval; }
}


void Nesso_set_debug(StradaValue* self, StradaValue* on) {
strada_incref(self);
strada_incref(on);
strada_hash_set(strada_deref_hash(self), "_debug", on);
strada_decref(self);
strada_decref(on);
}


StradaValue* Nesso_get_debug(StradaValue* self) {
strada_incref(self);
{ StradaValue *__retval = strada_hash_get(strada_deref_hash(self), "_debug");
    strada_incref(__retval);
    strada_decref(self);
    return __retval; }
}


void Nesso_define(StradaValue* self, StradaValue* name, StradaValue* schema) {
strada_incref(self);
strada_incref(name);
strada_incref(schema);
({ StradaValue *__hset_k = name; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_models")), __hset_ks, schema); free(__hset_ks); });
strada_decref(self);
strada_decref(name);
strada_decref(schema);
}


StradaValue* Nesso_columns(StradaValue* self, StradaValue* model) {
strada_incref(self);
strada_incref(model);
#line 213 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
{ StradaValue *__retval = strada_hash_get(strada_deref_hash(schema), "columns");
    strada_incref(__retval);
    strada_decref(schema);
    strada_decref(self);
    strada_decref(model);
    return __retval; }
strada_decref(schema);
}


StradaValue* Nesso_create(StradaValue* self, StradaValue* model, StradaValue* attrs) {
strada_incref(self);
strada_incref(model);
strada_incref(attrs);
#line 221 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 223 "lib/Nesso/test_nesso.strada"
StradaValue *record = strada_new_hash();
#line 226 "lib/Nesso/test_nesso.strada"
StradaValue *cols = strada_hash_get(strada_deref_hash(schema), "columns"); strada_incref(cols);
#line 227 "lib/Nesso/test_nesso.strada"
StradaValue *ncols = strada_new_int(strada_size(cols));
#line 228 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
while ((strada_to_num(i) < strada_to_num(ncols))) {
#line 230 "lib/Nesso/test_nesso.strada"
    StradaValue *col = strada_array_get(strada_deref_array(cols), strada_to_int(i)); strada_incref(col);
#line 231 "lib/Nesso/test_nesso.strada"
    StradaValue *val = ({ StradaValue *__hget_k = col; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(attrs), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(val);
    if (strada_defined_bool(val)) {
        ({ StradaValue *__hset_k = col; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(record), __hset_ks, val); free(__hset_ks); });
    }
    ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
    strada_decref(col);
    strada_decref(val);
}
{ StradaValue *__retval = ({ StradaValue *__meth_arg_1 = strada_new_ref(record, '%'); StradaValue *__meth_res = strada_method_call(self, "wrap_record", strada_pack_args(2, model, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
    strada_decref(schema);
    strada_decref(record);
    strada_decref(cols);
    strada_decref(ncols);
    strada_decref(i);
    strada_decref(self);
    strada_decref(model);
    strada_decref(attrs);
    return __retval; }
strada_decref(schema);
strada_decref(record);
strada_decref(cols);
strada_decref(ncols);
strada_decref(i);
}


StradaValue* Nesso_save(StradaValue* self, StradaValue* record) {
strada_incref(self);
strada_incref(record);
#line 243 "lib/Nesso/test_nesso.strada"
StradaValue *model_name = strada_hash_get(strada_deref_hash(record), "_model"); strada_incref(model_name);
#line 244 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model_name));
#line 245 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 247 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 248 "lib/Nesso/test_nesso.strada"
StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 249 "lib/Nesso/test_nesso.strada"
StradaValue *cols = strada_hash_get(strada_deref_hash(schema), "columns"); strada_incref(cols);
#line 250 "lib/Nesso/test_nesso.strada"
StradaValue *ncols = strada_new_int(strada_size(cols));
#line 253 "lib/Nesso/test_nesso.strada"
StradaValue *pk_val = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(pk_val);
if ((strada_defined_bool(pk_val) && (({ StradaValue *__num_tmp = strada_new_num(strada_to_num(pk_val) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) > 0.0))) {
#line 256 "lib/Nesso/test_nesso.strada"
    StradaValue *sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("UPDATE "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" SET "); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; });
#line 257 "lib/Nesso/test_nesso.strada"
    StradaValue *params = strada_new_array();
#line 258 "lib/Nesso/test_nesso.strada"
    StradaValue *first = strada_new_int(1);
#line 259 "lib/Nesso/test_nesso.strada"
    StradaValue *i = strada_new_int(0);
    while ((strada_to_num(i) < strada_to_num(ncols))) {
#line 261 "lib/Nesso/test_nesso.strada"
        StradaValue *col = strada_array_get(strada_deref_array(cols), strada_to_int(i)); strada_incref(col);
        if (({ StradaValue *__cond_tmp = ({ char *__cmp_ls = strada_to_str(col); char *__cmp_rs = strada_to_str(pk); int __cmp_res = strcmp(__cmp_ls, __cmp_rs) != 0; free(__cmp_ls); free(__cmp_rs); strada_new_int(__cmp_res); }); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
#line 263 "lib/Nesso/test_nesso.strada"
            StradaValue *val = ({ StradaValue *__hget_k = col; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(val);
            if (strada_defined_bool(val)) {
                if ((strada_to_num(first) == 0.0)) {
                    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_r = strada_new_str(", "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); sql; });
                }
                ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = strada_concat_sv(sql, col); StradaValue *__concat_r = strada_new_str(" = ?"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); sql; });
                ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(params), val), strada_undef_static()); strada_decref(__expr_tmp); });
                ({ StradaValue *__old = first; first = strada_new_int(0); strada_decref(__old); first; });
            }
            strada_decref(val);
        }
        ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
        strada_decref(col);
    }
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, pk); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" = ?"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); sql; });
    ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(params), pk_val), strada_undef_static()); strada_decref(__expr_tmp); });
    ({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
    ({ StradaValue *__expr_tmp = ({ StradaValue *__arg2 = strada_new_ref(params, '@'); StradaValue *__call_result = DBI_exec(db, sql, __arg2); strada_decref(__arg2); __call_result; }); strada_decref(__expr_tmp); });
    { StradaValue *__retval = strada_new_num(strada_to_num(pk_val) + 0.0);
        strada_decref(sql);
        strada_decref(params);
        strada_decref(first);
        strada_decref(i);
        strada_decref(model_name);
        strada_decref(schema);
        strada_decref(db);
        strada_decref(table);
        strada_decref(pk);
        strada_decref(cols);
        strada_decref(ncols);
        strada_decref(pk_val);
        strada_decref(self);
        strada_decref(record);
        return __retval; }
    strada_decref(sql);
    strada_decref(params);
    strada_decref(first);
    strada_decref(i);
} else {
#line 282 "lib/Nesso/test_nesso.strada"
    StradaValue *col_list = strada_new_str("");
#line 283 "lib/Nesso/test_nesso.strada"
    StradaValue *placeholders = strada_new_str("");
#line 284 "lib/Nesso/test_nesso.strada"
    StradaValue *params = strada_new_array();
#line 285 "lib/Nesso/test_nesso.strada"
    StradaValue *first = strada_new_int(1);
#line 286 "lib/Nesso/test_nesso.strada"
    StradaValue *i = strada_new_int(0);
    while ((strada_to_num(i) < strada_to_num(ncols))) {
#line 288 "lib/Nesso/test_nesso.strada"
        StradaValue *col = strada_array_get(strada_deref_array(cols), strada_to_int(i)); strada_incref(col);
        if (({ StradaValue *__cond_tmp = ({ char *__cmp_ls = strada_to_str(col); char *__cmp_rs = strada_to_str(pk); int __cmp_res = strcmp(__cmp_ls, __cmp_rs) != 0; free(__cmp_ls); free(__cmp_rs); strada_new_int(__cmp_res); }); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
#line 290 "lib/Nesso/test_nesso.strada"
            StradaValue *val = ({ StradaValue *__hget_k = col; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(val);
            if (strada_defined_bool(val)) {
                if ((strada_to_num(first) == 0.0)) {
                    ({ StradaValue *__old = col_list; col_list = ({ StradaValue *__concat_r = strada_new_str(", "); StradaValue *__concat_res = strada_concat_sv(col_list, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); col_list; });
                    ({ StradaValue *__old = placeholders; placeholders = ({ StradaValue *__concat_r = strada_new_str(", "); StradaValue *__concat_res = strada_concat_sv(placeholders, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); placeholders; });
                }
                ({ StradaValue *__old = col_list; col_list = strada_concat_sv(col_list, col); strada_decref(__old); col_list; });
                ({ StradaValue *__old = placeholders; placeholders = ({ StradaValue *__concat_r = strada_new_str("?"); StradaValue *__concat_res = strada_concat_sv(placeholders, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); placeholders; });
                ({ StradaValue *__expr_tmp = (strada_array_push(strada_deref_array(params), val), strada_undef_static()); strada_decref(__expr_tmp); });
                ({ StradaValue *__old = first; first = strada_new_int(0); strada_decref(__old); first; });
            }
            strada_decref(val);
        }
        ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
        strada_decref(col);
    }
#line 304 "lib/Nesso/test_nesso.strada"
    StradaValue *sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("INSERT INTO "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" ("); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, col_list); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(") VALUES ("); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, placeholders); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(")"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; });
    ({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 306 "lib/Nesso/test_nesso.strada"
    StradaValue *id = ({ StradaValue *__arg2 = strada_new_ref(params, '@'); StradaValue *__call_result = DBI_insert_get_id(db, sql, __arg2); strada_decref(__arg2); __call_result; });
    ({ StradaValue *__hset_k = pk; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(record), __hset_ks, id); free(__hset_ks); });
    { StradaValue *__retval = id;
        strada_incref(__retval);
        strada_decref(col_list);
        strada_decref(placeholders);
        strada_decref(params);
        strada_decref(first);
        strada_decref(i);
        strada_decref(sql);
        strada_decref(id);
        strada_decref(model_name);
        strada_decref(schema);
        strada_decref(db);
        strada_decref(table);
        strada_decref(pk);
        strada_decref(cols);
        strada_decref(ncols);
        strada_decref(pk_val);
        strada_decref(self);
        strada_decref(record);
        return __retval; }
    strada_decref(col_list);
    strada_decref(placeholders);
    strada_decref(params);
    strada_decref(first);
    strada_decref(i);
    strada_decref(sql);
    strada_decref(id);
}
strada_decref(model_name);
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(pk);
strada_decref(cols);
strada_decref(ncols);
strada_decref(pk_val);
}


StradaValue* Nesso_find(StradaValue* self, StradaValue* model, StradaValue* id) {
strada_incref(self);
strada_incref(model);
strada_incref(id);
#line 314 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 315 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 317 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 318 "lib/Nesso/test_nesso.strada"
StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 319 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("SELECT * FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, pk); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" = ?"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_anon_array(1, id); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 321 "lib/Nesso/test_nesso.strada"
StradaValue *row = ({ StradaValue *__arg2 = strada_anon_array(1, id); StradaValue *__call_result = DBI_selectrow_hashref(db, sql, __arg2); strada_decref(__arg2); __call_result; });
{ StradaValue *__retval = strada_method_call(self, "wrap_record", strada_pack_args(2, model, row));
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(pk);
    strada_decref(sql);
    strada_decref(row);
    strada_decref(self);
    strada_decref(model);
    strada_decref(id);
    return __retval; }
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(pk);
strada_decref(sql);
strada_decref(row);
}


StradaValue* Nesso_find_by(StradaValue* self, StradaValue* model, StradaValue* conds) {
strada_incref(self);
strada_incref(model);
strada_incref(conds);
#line 327 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 328 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 330 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 331 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = strada_new_str("SELECT * FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; });
#line 332 "lib/Nesso/test_nesso.strada"
StradaValue *params = strada_new_array();
#line 334 "lib/Nesso/test_nesso.strada"
StradaValue *wc = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "build_where_clause", strada_pack_args(2, conds, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_ne_lit(wc, "")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, wc); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
if (strada_defined_bool(strada_hash_get(strada_deref_hash(conds), "_order"))) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" ORDER BY "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, strada_hash_get(strada_deref_hash(conds), "_order")); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_r = strada_new_str(" LIMIT 1"); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); strada_decref(__old); sql; });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 347 "lib/Nesso/test_nesso.strada"
StradaValue *row = ({ StradaValue *__arg2 = strada_new_ref(params, '@'); StradaValue *__call_result = DBI_selectrow_hashref(db, sql, __arg2); strada_decref(__arg2); __call_result; });
{ StradaValue *__retval = strada_method_call(self, "wrap_record", strada_pack_args(2, model, row));
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(sql);
    strada_decref(params);
    strada_decref(wc);
    strada_decref(row);
    strada_decref(self);
    strada_decref(model);
    strada_decref(conds);
    return __retval; }
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(sql);
strada_decref(params);
strada_decref(wc);
strada_decref(row);
}


StradaValue* Nesso_where(StradaValue* self, StradaValue* model, StradaValue* conds) {
strada_incref(self);
strada_incref(model);
strada_incref(conds);
#line 353 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 354 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 356 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 357 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = strada_new_str("SELECT * FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; });
#line 358 "lib/Nesso/test_nesso.strada"
StradaValue *params = strada_new_array();
#line 360 "lib/Nesso/test_nesso.strada"
StradaValue *wc = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "build_where_clause", strada_pack_args(2, conds, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_ne_lit(wc, "")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, wc); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
if (strada_defined_bool(strada_hash_get(strada_deref_hash(conds), "_order"))) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" ORDER BY "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, strada_hash_get(strada_deref_hash(conds), "_order")); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
if (strada_defined_bool(strada_hash_get(strada_deref_hash(conds), "_limit"))) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" LIMIT "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, strada_hash_get(strada_deref_hash(conds), "_limit")); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
if (strada_defined_bool(strada_hash_get(strada_deref_hash(conds), "_offset"))) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" OFFSET "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, strada_hash_get(strada_deref_hash(conds), "_offset")); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 377 "lib/Nesso/test_nesso.strada"
StradaValue *rows = ({ StradaValue *__arg2 = strada_new_ref(params, '@'); StradaValue *__call_result = DBI_selectall_hashref(db, sql, __arg2); strada_decref(__arg2); __call_result; });
{ StradaValue *__retval = strada_method_call(self, "tag_rows", strada_pack_args(2, model, rows));
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(sql);
    strada_decref(params);
    strada_decref(wc);
    strada_decref(rows);
    strada_decref(self);
    strada_decref(model);
    strada_decref(conds);
    return __retval; }
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(sql);
strada_decref(params);
strada_decref(wc);
strada_decref(rows);
}


StradaValue* Nesso_all(StradaValue* self, StradaValue* model) {
strada_incref(self);
strada_incref(model);
#line 383 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 384 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 386 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 387 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = strada_new_str("SELECT * FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_anon_array(0); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 389 "lib/Nesso/test_nesso.strada"
StradaValue *rows = ({ StradaValue *__arg2 = strada_anon_array(0); StradaValue *__call_result = DBI_selectall_hashref(db, sql, __arg2); strada_decref(__arg2); __call_result; });
{ StradaValue *__retval = strada_method_call(self, "tag_rows", strada_pack_args(2, model, rows));
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(sql);
    strada_decref(rows);
    strada_decref(self);
    strada_decref(model);
    return __retval; }
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(sql);
strada_decref(rows);
}


StradaValue* Nesso_count(StradaValue* self, StradaValue* model, StradaValue* conds) {
strada_incref(self);
strada_incref(model);
strada_incref(conds);
#line 395 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model));
#line 396 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 398 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 399 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = strada_new_str("SELECT COUNT(*) FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; });
#line 400 "lib/Nesso/test_nesso.strada"
StradaValue *params = strada_new_array();
#line 402 "lib/Nesso/test_nesso.strada"
StradaValue *wc = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "build_where_clause", strada_pack_args(2, conds, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_ne_lit(wc, "")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
    ({ StradaValue *__old = sql; sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(sql, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, wc); strada_decref(__concat_l); __concat_res; }); strada_decref(__old); sql; });
}
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_ref(params, '@'); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 408 "lib/Nesso/test_nesso.strada"
StradaValue *result = ({ StradaValue *__arg2 = strada_new_ref(params, '@'); StradaValue *__call_result = DBI_selectcol(db, sql, __arg2); strada_decref(__arg2); __call_result; });
if (strada_defined_bool(result)) {
    { StradaValue *__retval = strada_new_num(strada_to_num(result) + 0.0);
        strada_decref(schema);
        strada_decref(db);
        strada_decref(table);
        strada_decref(sql);
        strada_decref(params);
        strada_decref(wc);
        strada_decref(result);
        strada_decref(self);
        strada_decref(model);
        strada_decref(conds);
        return __retval; }
}
{ StradaValue *__retval = strada_new_int(0);
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(sql);
    strada_decref(params);
    strada_decref(wc);
    strada_decref(result);
    strada_decref(self);
    strada_decref(model);
    strada_decref(conds);
    return __retval; }
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(sql);
strada_decref(params);
strada_decref(wc);
strada_decref(result);
}


StradaValue* Nesso_delete(StradaValue* self, StradaValue* record) {
strada_incref(self);
strada_incref(record);
#line 417 "lib/Nesso/test_nesso.strada"
StradaValue *model_name = strada_hash_get(strada_deref_hash(record), "_model"); strada_incref(model_name);
#line 418 "lib/Nesso/test_nesso.strada"
StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model_name));
#line 419 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
#line 421 "lib/Nesso/test_nesso.strada"
StradaValue *table = strada_hash_get(strada_deref_hash(schema), "table"); strada_incref(table);
#line 422 "lib/Nesso/test_nesso.strada"
StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 423 "lib/Nesso/test_nesso.strada"
StradaValue *pk_val = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(pk_val);
#line 425 "lib/Nesso/test_nesso.strada"
StradaValue *sql = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("DELETE FROM "); StradaValue *__concat_res = strada_concat_sv(__concat_l, table); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" WHERE "); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, pk); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" = ?"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_anon_array(1, pk_val); StradaValue *__meth_res = strada_method_call(self, "log_sql", strada_pack_args(2, sql, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
{ StradaValue *__retval = ({ StradaValue *__arg2 = strada_anon_array(1, pk_val); StradaValue *__call_result = DBI_exec(db, sql, __arg2); strada_decref(__arg2); __call_result; });
    strada_decref(model_name);
    strada_decref(schema);
    strada_decref(db);
    strada_decref(table);
    strada_decref(pk);
    strada_decref(pk_val);
    strada_decref(sql);
    strada_decref(self);
    strada_decref(record);
    return __retval; }
strada_decref(model_name);
strada_decref(schema);
strada_decref(db);
strada_decref(table);
strada_decref(pk);
strada_decref(pk_val);
strada_decref(sql);
}


StradaValue* Nesso_query(StradaValue* self, StradaValue* sql, StradaValue* params) {
strada_incref(self);
strada_incref(sql);
strada_incref(params);
#line 432 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
({ StradaValue *__expr_tmp = strada_method_call(self, "log_sql", strada_pack_args(2, sql, params)); strada_decref(__expr_tmp); });
{ StradaValue *__retval = DBI_selectall_hashref(db, sql, params);
    strada_decref(db);
    strada_decref(self);
    strada_decref(sql);
    strada_decref(params);
    return __retval; }
strada_decref(db);
}


void Nesso_transaction(StradaValue* self, StradaValue* cb) {
strada_incref(self);
strada_incref(cb);
#line 439 "lib/Nesso/test_nesso.strada"
StradaValue *db = strada_hash_get(strada_deref_hash(self), "_dbh"); strada_incref(db);
({ StradaValue *__expr_tmp = DBI_begin_work(db); strada_decref(__expr_tmp); });
if (setjmp(*STRADA_TRY_PUSH()) == 0) {
    strada_closure_call(cb, 0);
    ({ StradaValue *__expr_tmp = DBI_commit(db); strada_decref(__expr_tmp); });
    STRADA_TRY_POP();
} else {
    STRADA_TRY_POP();
    StradaValue *__strada_exc = strada_get_exception();
    {
        StradaValue *e = __strada_exc;
        ({ StradaValue *__expr_tmp = DBI_rollback(db); strada_decref(__expr_tmp); });
        strada_throw_value(e);
        strada_decref(e);
    }
}
strada_decref(db);
strada_decref(self);
strada_decref(cb);
}


void Nesso_has_many(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* fk) {
strada_incref(self);
strada_incref(owner);
strada_incref(name);
strada_incref(fk);
#line 454 "lib/Nesso/test_nesso.strada"
StradaValue *key = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(":"); StradaValue *__concat_res = strada_concat_sv(owner, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, name); strada_decref(__concat_l); __concat_res; });
#line 455 "lib/Nesso/test_nesso.strada"
StradaValue *rel = strada_new_hash();
({ StradaValue *__hset_v = strada_new_str("has_many"); strada_hash_set(strada_deref_hash(rel), "type", __hset_v); strada_decref(__hset_v); });
strada_hash_set(strada_deref_hash(rel), "model", name);
strada_hash_set(strada_deref_hash(rel), "key", fk);
({ StradaValue *__hset_v = strada_new_ref(rel, '%'); StradaValue *__hset_k = key; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_relations")), __hset_ks, __hset_v); free(__hset_ks); strada_decref(__hset_v); });
strada_decref(key);
strada_decref(rel);
strada_decref(self);
strada_decref(owner);
strada_decref(name);
strada_decref(fk);
}


void Nesso_belongs_to(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk) {
strada_incref(self);
strada_incref(owner);
strada_incref(name);
strada_incref(target);
strada_incref(fk);
#line 464 "lib/Nesso/test_nesso.strada"
StradaValue *key = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(":"); StradaValue *__concat_res = strada_concat_sv(owner, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, name); strada_decref(__concat_l); __concat_res; });
#line 465 "lib/Nesso/test_nesso.strada"
StradaValue *rel = strada_new_hash();
({ StradaValue *__hset_v = strada_new_str("belongs_to"); strada_hash_set(strada_deref_hash(rel), "type", __hset_v); strada_decref(__hset_v); });
strada_hash_set(strada_deref_hash(rel), "model", target);
strada_hash_set(strada_deref_hash(rel), "key", fk);
({ StradaValue *__hset_v = strada_new_ref(rel, '%'); StradaValue *__hset_k = key; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_relations")), __hset_ks, __hset_v); free(__hset_ks); strada_decref(__hset_v); });
strada_decref(key);
strada_decref(rel);
strada_decref(self);
strada_decref(owner);
strada_decref(name);
strada_decref(target);
strada_decref(fk);
}


void Nesso_has_one(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk) {
strada_incref(self);
strada_incref(owner);
strada_incref(name);
strada_incref(target);
strada_incref(fk);
#line 474 "lib/Nesso/test_nesso.strada"
StradaValue *key = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(":"); StradaValue *__concat_res = strada_concat_sv(owner, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, name); strada_decref(__concat_l); __concat_res; });
#line 475 "lib/Nesso/test_nesso.strada"
StradaValue *rel = strada_new_hash();
({ StradaValue *__hset_v = strada_new_str("has_one"); strada_hash_set(strada_deref_hash(rel), "type", __hset_v); strada_decref(__hset_v); });
strada_hash_set(strada_deref_hash(rel), "model", target);
strada_hash_set(strada_deref_hash(rel), "key", fk);
({ StradaValue *__hset_v = strada_new_ref(rel, '%'); StradaValue *__hset_k = key; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_relations")), __hset_ks, __hset_v); free(__hset_ks); strada_decref(__hset_v); });
strada_decref(key);
strada_decref(rel);
strada_decref(self);
strada_decref(owner);
strada_decref(name);
strada_decref(target);
strada_decref(fk);
}


StradaValue* Nesso_related(StradaValue* self, StradaValue* record, StradaValue* name) {
strada_incref(self);
strada_incref(record);
strada_incref(name);
#line 484 "lib/Nesso/test_nesso.strada"
StradaValue *model_name = strada_hash_get(strada_deref_hash(record), "_model"); strada_incref(model_name);
#line 485 "lib/Nesso/test_nesso.strada"
StradaValue *rel_key = ({ StradaValue *__concat_l = ({ StradaValue *__concat_r = strada_new_str(":"); StradaValue *__concat_res = strada_concat_sv(model_name, __concat_r); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, name); strada_decref(__concat_l); __concat_res; });
#line 486 "lib/Nesso/test_nesso.strada"
StradaValue *rel = ({ StradaValue *__hget_k = rel_key; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(strada_hash_get(strada_deref_hash(self), "_relations")), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(rel);
if (!(strada_defined_bool(rel))) {
    strada_throw_value(({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("Nesso: unknown relation '"); StradaValue *__concat_res = strada_concat_sv(__concat_l, name); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("' on model '"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, model_name); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("'"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }));
}
#line 491 "lib/Nesso/test_nesso.strada"
StradaValue *type = strada_hash_get(strada_deref_hash(rel), "type"); strada_incref(type);
#line 492 "lib/Nesso/test_nesso.strada"
StradaValue *rel_model = strada_hash_get(strada_deref_hash(rel), "model"); strada_incref(rel_model);
#line 493 "lib/Nesso/test_nesso.strada"
StradaValue *fk = strada_hash_get(strada_deref_hash(rel), "key"); strada_incref(fk);
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_eq_lit(type, "has_many")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
#line 496 "lib/Nesso/test_nesso.strada"
    StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model_name));
#line 497 "lib/Nesso/test_nesso.strada"
    StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 498 "lib/Nesso/test_nesso.strada"
    StradaValue *pk_val = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(pk_val);
#line 499 "lib/Nesso/test_nesso.strada"
    StradaValue *conds = strada_new_hash();
    ({ StradaValue *__hset_k = fk; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(conds), __hset_ks, pk_val); free(__hset_ks); });
    { StradaValue *__retval = ({ StradaValue *__meth_arg_1 = strada_new_ref(conds, '%'); StradaValue *__meth_res = strada_method_call(self, "where", strada_pack_args(2, rel_model, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
        strada_decref(schema);
        strada_decref(pk);
        strada_decref(pk_val);
        strada_decref(conds);
        strada_decref(model_name);
        strada_decref(rel_key);
        strada_decref(rel);
        strada_decref(type);
        strada_decref(rel_model);
        strada_decref(fk);
        strada_decref(self);
        strada_decref(record);
        strada_decref(name);
        return __retval; }
    strada_decref(schema);
    strada_decref(pk);
    strada_decref(pk_val);
    strada_decref(conds);
}
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_eq_lit(type, "belongs_to")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
#line 505 "lib/Nesso/test_nesso.strada"
    StradaValue *fk_val = ({ StradaValue *__hget_k = fk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(fk_val);
    if (!(strada_defined_bool(fk_val))) {
        { StradaValue *__retval = strada_new_undef();
            strada_decref(fk_val);
            strada_decref(model_name);
            strada_decref(rel_key);
            strada_decref(rel);
            strada_decref(type);
            strada_decref(rel_model);
            strada_decref(fk);
            strada_decref(self);
            strada_decref(record);
            strada_decref(name);
            return __retval; }
    }
    { StradaValue *__retval = ({ StradaValue *__meth_arg_1 = strada_new_num(strada_to_num(fk_val) + 0.0); StradaValue *__meth_res = strada_method_call(self, "find", strada_pack_args(2, rel_model, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
        strada_decref(fk_val);
        strada_decref(model_name);
        strada_decref(rel_key);
        strada_decref(rel);
        strada_decref(type);
        strada_decref(rel_model);
        strada_decref(fk);
        strada_decref(self);
        strada_decref(record);
        strada_decref(name);
        return __retval; }
    strada_decref(fk_val);
}
if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_eq_lit(type, "has_one")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
#line 513 "lib/Nesso/test_nesso.strada"
    StradaValue *schema = strada_method_call(self, "get_schema", strada_pack_args(1, model_name));
#line 514 "lib/Nesso/test_nesso.strada"
    StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 515 "lib/Nesso/test_nesso.strada"
    StradaValue *pk_val = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(record), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(pk_val);
#line 516 "lib/Nesso/test_nesso.strada"
    StradaValue *conds = strada_new_hash();
    ({ StradaValue *__hset_k = fk; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(conds), __hset_ks, pk_val); free(__hset_ks); });
    { StradaValue *__retval = ({ StradaValue *__meth_arg_1 = strada_new_ref(conds, '%'); StradaValue *__meth_res = strada_method_call(self, "find_by", strada_pack_args(2, rel_model, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
        strada_decref(schema);
        strada_decref(pk);
        strada_decref(pk_val);
        strada_decref(conds);
        strada_decref(model_name);
        strada_decref(rel_key);
        strada_decref(rel);
        strada_decref(type);
        strada_decref(rel_model);
        strada_decref(fk);
        strada_decref(self);
        strada_decref(record);
        strada_decref(name);
        return __retval; }
    strada_decref(schema);
    strada_decref(pk);
    strada_decref(pk_val);
    strada_decref(conds);
}
strada_throw_value(({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("Nesso: unknown relation type '"); StradaValue *__concat_res = strada_concat_sv(__concat_l, type); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str("'"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }));
strada_decref(model_name);
strada_decref(rel_key);
strada_decref(rel);
strada_decref(type);
strada_decref(rel_model);
strada_decref(fk);
}


StradaValue* Nesso_clone(StradaValue* self, StradaValue* new_dbh) {
strada_incref(self);
strada_incref(new_dbh);
#line 528 "lib/Nesso/test_nesso.strada"
StradaValue *new_self = strada_new_hash();
strada_hash_set(strada_deref_hash(new_self), "_dbh", new_dbh);
strada_hash_set(strada_deref_hash(new_self), "_models", strada_hash_get(strada_deref_hash(self), "_models"));
strada_hash_set(strada_deref_hash(new_self), "_relations", strada_hash_get(strada_deref_hash(self), "_relations"));
strada_hash_set(strada_deref_hash(new_self), "_debug", strada_hash_get(strada_deref_hash(self), "_debug"));
{ StradaValue *__retval = strada_bless(strada_new_ref(new_self, '%'), "Nesso");
    strada_decref(new_self);
    strada_decref(self);
    strada_decref(new_dbh);
    return __retval; }
strada_decref(new_self);
}


StradaValue* Nesso_Record_save(StradaValue* self) {
strada_incref(self);
#line 32 "lib/Nesso/test_nesso.strada"
StradaValue *nesso = strada_hash_get(strada_deref_hash(self), "_nesso"); strada_incref(nesso);
{ StradaValue *__retval = Nesso_save(nesso, self);
    strada_decref(nesso);
    strada_decref(self);
    return __retval; }
strada_decref(nesso);
}


StradaValue* Nesso_Record_update(StradaValue* self, StradaValue* attrs) {
strada_incref(self);
strada_incref(attrs);
#line 38 "lib/Nesso/test_nesso.strada"
StradaValue *keys = strada_new_array_from_av(strada_hash_keys(strada_deref_hash(attrs)));
#line 39 "lib/Nesso/test_nesso.strada"
StradaValue *i = strada_new_int(0);
#line 40 "lib/Nesso/test_nesso.strada"
StradaValue *n = strada_new_int(strada_array_length(strada_deref_array(keys)));
while ((strada_to_num(i) < strada_to_num(n))) {
#line 42 "lib/Nesso/test_nesso.strada"
    StradaValue *key = strada_array_get(strada_deref_array(keys), strada_to_int(i)); strada_incref(key);
    ({ StradaValue *__hset_k = key; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(self), __hset_ks, ({ StradaValue *__hget_k = key; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(attrs), __hget_ks); free(__hget_ks); __hget_r; })); free(__hset_ks); });
    ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
    strada_decref(key);
}
{ StradaValue *__retval = strada_method_call(self, "save", strada_pack_args(0));
    strada_decref(keys);
    strada_decref(i);
    strada_decref(n);
    strada_decref(self);
    strada_decref(attrs);
    return __retval; }
strada_decref(keys);
strada_decref(i);
strada_decref(n);
}


StradaValue* Nesso_Record_delete(StradaValue* self) {
strada_incref(self);
#line 51 "lib/Nesso/test_nesso.strada"
StradaValue *nesso = strada_hash_get(strada_deref_hash(self), "_nesso"); strada_incref(nesso);
{ StradaValue *__retval = Nesso_delete(nesso, self);
    strada_decref(nesso);
    strada_decref(self);
    return __retval; }
strada_decref(nesso);
}


StradaValue* Nesso_Record_reload(StradaValue* self) {
strada_incref(self);
#line 57 "lib/Nesso/test_nesso.strada"
StradaValue *nesso = strada_hash_get(strada_deref_hash(self), "_nesso"); strada_incref(nesso);
#line 58 "lib/Nesso/test_nesso.strada"
StradaValue *model = strada_hash_get(strada_deref_hash(self), "_model"); strada_incref(model);
#line 59 "lib/Nesso/test_nesso.strada"
StradaValue *schema = Nesso_get_schema(nesso, model);
#line 60 "lib/Nesso/test_nesso.strada"
StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
#line 61 "lib/Nesso/test_nesso.strada"
StradaValue *pk_val = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(self), __hget_ks); free(__hget_ks); __hget_r; }); strada_incref(pk_val);
#line 63 "lib/Nesso/test_nesso.strada"
StradaValue *fresh = ({ StradaValue *__arg2 = strada_new_num(strada_to_num(pk_val) + 0.0); StradaValue *__call_result = Nesso_find(nesso, model, __arg2); strada_decref(__arg2); __call_result; });
if (strada_defined_bool(fresh)) {
#line 66 "lib/Nesso/test_nesso.strada"
    StradaValue *keys = strada_new_array_from_av(strada_hash_keys(strada_deref_hash(fresh)));
#line 67 "lib/Nesso/test_nesso.strada"
    StradaValue *i = strada_new_int(0);
#line 68 "lib/Nesso/test_nesso.strada"
    StradaValue *n = strada_new_int(strada_array_length(strada_deref_array(keys)));
    while ((strada_to_num(i) < strada_to_num(n))) {
#line 70 "lib/Nesso/test_nesso.strada"
        StradaValue *key = strada_array_get(strada_deref_array(keys), strada_to_int(i)); strada_incref(key);
        if (({ StradaValue *__cond_tmp = strada_new_int(strada_str_ne_lit(key, "_nesso")); int __cond_res = strada_to_bool(__cond_tmp); strada_decref(__cond_tmp); __cond_res; })) {
            ({ StradaValue *__hset_k = key; char *__hset_ks = strada_to_str(__hset_k); strada_hash_set(strada_deref_hash(self), __hset_ks, ({ StradaValue *__hget_k = key; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(fresh), __hget_ks); free(__hget_ks); __hget_r; })); free(__hset_ks); });
        }
        ({ StradaValue *__expr_tmp = strada_postincr(&i); strada_decref(__expr_tmp); });
        strada_decref(key);
    }
    strada_decref(keys);
    strada_decref(i);
    strada_decref(n);
}
{ StradaValue *__retval = self;
    strada_incref(__retval);
    strada_decref(nesso);
    strada_decref(model);
    strada_decref(schema);
    strada_decref(pk);
    strada_decref(pk_val);
    strada_decref(fresh);
    strada_decref(self);
    return __retval; }
strada_decref(nesso);
strada_decref(model);
strada_decref(schema);
strada_decref(pk);
strada_decref(pk_val);
strada_decref(fresh);
}


StradaValue* Nesso_Record_related(StradaValue* self, StradaValue* name) {
strada_incref(self);
strada_incref(name);
#line 82 "lib/Nesso/test_nesso.strada"
StradaValue *nesso = strada_hash_get(strada_deref_hash(self), "_nesso"); strada_incref(nesso);
{ StradaValue *__retval = Nesso_related(nesso, self, name);
    strada_decref(nesso);
    strada_decref(self);
    strada_decref(name);
    return __retval; }
strada_decref(nesso);
}


StradaValue* Nesso_Record_model(StradaValue* self) {
strada_incref(self);
{ StradaValue *__retval = strada_hash_get(strada_deref_hash(self), "_model");
    strada_incref(__retval);
    strada_decref(self);
    return __retval; }
}


StradaValue* Nesso_Record_id(StradaValue* self) {
strada_incref(self);
#line 93 "lib/Nesso/test_nesso.strada"
StradaValue *nesso = strada_hash_get(strada_deref_hash(self), "_nesso"); strada_incref(nesso);
#line 94 "lib/Nesso/test_nesso.strada"
StradaValue *model = strada_hash_get(strada_deref_hash(self), "_model"); strada_incref(model);
#line 95 "lib/Nesso/test_nesso.strada"
StradaValue *schema = Nesso_get_schema(nesso, model);
#line 96 "lib/Nesso/test_nesso.strada"
StradaValue *pk = strada_hash_get(strada_deref_hash(schema), "primary"); strada_incref(pk);
{ StradaValue *__retval = ({ StradaValue *__hget_k = pk; char *__hget_ks = strada_to_str(__hget_k); StradaValue *__hget_r = strada_hash_get(strada_deref_hash(self), __hget_ks); free(__hget_ks); __hget_r; });
    strada_incref(__retval);
    strada_decref(nesso);
    strada_decref(model);
    strada_decref(schema);
    strada_decref(pk);
    strada_decref(self);
    return __retval; }
strada_decref(nesso);
strada_decref(model);
strada_decref(schema);
strada_decref(pk);
}


StradaValue* Nesso_Record_is_new(StradaValue* self) {
strada_incref(self);
#line 102 "lib/Nesso/test_nesso.strada"
StradaValue *id_val = strada_method_call(self, "id", strada_pack_args(0));
if ((!(strada_defined_bool(id_val)) || (({ StradaValue *__num_tmp = strada_new_num(strada_to_num(id_val) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0))) {
    { StradaValue *__retval = strada_new_int(1);
        strada_decref(id_val);
        strada_decref(self);
        return __retval; }
}
{ StradaValue *__retval = strada_new_int(0);
    strada_decref(id_val);
    strada_decref(self);
    return __retval; }
strada_decref(id_val);
}


StradaValue* AdminUser_is_super_admin(StradaValue* self) {
strada_incref(self);
#line 32 "lib/Nesso/test_nesso.strada"
StradaValue *level = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(self), "access_level")) + 0.0);
{ StradaValue *__retval = ((strada_to_num(level) >= 10.0) ? strada_new_int(1) : strada_new_int(0));
    strada_decref(level);
    strada_decref(self);
    return __retval; }
strada_decref(level);
}


void AdminUser_promote(StradaValue* self) {
strada_incref(self);
#line 38 "lib/Nesso/test_nesso.strada"
StradaValue *level = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(self), "access_level")) + 0.0);
({ StradaValue *__hset_v = strada_new_num(strada_to_num(level) + 1.0); strada_hash_set(strada_deref_hash(self), "access_level", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__expr_tmp = strada_method_call(self, "save", strada_pack_args(0)); strada_decref(__expr_tmp); });
strada_decref(level);
strada_decref(self);
}


void ok(StradaValue* cond, StradaValue* msg) {
strada_incref(cond);
strada_incref(msg);
if (strada_to_bool(cond)) {
    ({ StradaValue *__say_tmp = ({ StradaValue *__concat_l = strada_new_str("  ok: "); StradaValue *__concat_res = strada_concat_sv(__concat_l, msg); strada_decref(__concat_l); __concat_res; }); strada_say(__say_tmp); strada_decref(__say_tmp); });
    ({ StradaValue *__expr_tmp = strada_postincr(&g_pass); strada_decref(__expr_tmp); });
} else {
    ({ StradaValue *__say_tmp = ({ StradaValue *__concat_l = strada_new_str("  FAIL: "); StradaValue *__concat_res = strada_concat_sv(__concat_l, msg); strada_decref(__concat_l); __concat_res; }); strada_say(__say_tmp); strada_decref(__say_tmp); });
    ({ StradaValue *__expr_tmp = strada_postincr(&g_fail); strada_decref(__expr_tmp); });
}
strada_decref(cond);
strada_decref(msg);
}


int main(int _argc, char **_argv) {
    /* Initialize proctitle support */
    strada_init_proctitle(_argc, _argv);

    /* Populate global ARGV array */
    ARGV = strada_new_array();
    for (int i = 0; i < _argc; i++) {
        strada_array_push(ARGV->value.av, strada_new_str(_argv[i]));
    }
    ARGC = strada_new_int(_argc);

    /* Set package from file-level declaration */
    strada_set_package("main");

    /* Set up inheritance from file-level declarations */
    strada_inherit("AdminUser", "Nesso::Record");

    /* Initialize OOP method registration */
    __DBI_oop_init();
    __Nesso_oop_init();
    __Nesso_Record_oop_init();
    __AdminUser_oop_init();

    /* Initialize global variables */
    g_pass = strada_new_int(0);
    g_fail = strada_new_int(0);

#line 60 "lib/Nesso/test_nesso.strada"
StradaValue *db = ({ StradaValue *__arg0 = strada_new_str("dbi:SQLite::memory:"); StradaValue *__arg1 = strada_new_str(""); StradaValue *__arg2 = strada_new_str(""); StradaValue *__call_result = DBI_connect(__arg0, __arg1, __arg2); strada_decref(__arg0); strada_decref(__arg1); strada_decref(__arg2); __call_result; });
if (!(strada_defined_bool(db))) {
    ({ StradaValue *__say_tmp = strada_new_str("FAIL: Could not connect to SQLite"); strada_say(__say_tmp); strada_decref(__say_tmp); });
        strada_decref(db);
    return 1;
}
#line 66 "lib/Nesso/test_nesso.strada"
StradaValue *n = Nesso_new(db);
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT, age INTEGER, active INTEGER DEFAULT 1)"); StradaValue *__call_result = DBI_do_sql(db, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE accounts (id INTEGER PRIMARY KEY, owner TEXT, balance INTEGER)"); StradaValue *__call_result = DBI_do_sql(db, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE posts (id INTEGER PRIMARY KEY, user_id INTEGER, title TEXT, body TEXT)"); StradaValue *__call_result = DBI_do_sql(db, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE profiles (id INTEGER PRIMARY KEY, user_id INTEGER, bio TEXT)"); StradaValue *__call_result = DBI_do_sql(db, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("users"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("username"); StradaValue *__aa_el2 = strada_new_str("email"); StradaValue *__aa_el3 = strada_new_str("age"); StradaValue *__aa_el4 = strada_new_str("active"); StradaValue *__aa_arr = strada_anon_array(5, __aa_el0, __aa_el1, __aa_el2, __aa_el3, __aa_el4); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); strada_decref(__aa_el3); strada_decref(__aa_el4); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_hash = strada_anon_hash(3, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("accounts"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("owner"); StradaValue *__aa_el2 = strada_new_str("balance"); StradaValue *__aa_arr = strada_anon_array(3, __aa_el0, __aa_el1, __aa_el2); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_hash = strada_anon_hash(3, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("posts"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("user_id"); StradaValue *__aa_el2 = strada_new_str("title"); StradaValue *__aa_el3 = strada_new_str("body"); StradaValue *__aa_arr = strada_anon_array(4, __aa_el0, __aa_el1, __aa_el2, __aa_el3); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); strada_decref(__aa_el3); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_hash = strada_anon_hash(3, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("profiles"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("profiles"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("user_id"); StradaValue *__aa_el2 = strada_new_str("bio"); StradaValue *__aa_arr = strada_anon_array(3, __aa_el0, __aa_el1, __aa_el2); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_hash = strada_anon_hash(3, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__say_tmp = strada_new_str("Test: create and save (insert)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 101 "lib/Nesso/test_nesso.strada"
StradaValue *u1 = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("alice"); StradaValue *__ah_val1 = strada_new_str("alice@example.com"); StradaValue *__ah_val2 = strada_new_int(28); StradaValue *__ah_val3 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_defined(u1); StradaValue *__arg1 = strada_new_str("create returns a record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(u1), "_model"), "users")); StradaValue *__arg1 = strada_new_str("record has _model tag"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(u1), "username"), "alice")); StradaValue *__arg1 = strada_new_str("record has correct username"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 111 "lib/Nesso/test_nesso.strada"
StradaValue *id1 = strada_method_call(n, "save", strada_pack_args(1, u1));
({ StradaValue *__arg0 = strada_new_int(strada_to_num(id1) > 0.0); StradaValue *__arg1 = strada_new_str("save returns id > 0"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_to_num(strada_hash_get(strada_deref_hash(u1), "id")) == strada_to_num(id1)); StradaValue *__arg1 = strada_new_str("record id is set after save"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 116 "lib/Nesso/test_nesso.strada"
StradaValue *u2 = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("bob"); StradaValue *__ah_val1 = strada_new_str("bob@example.com"); StradaValue *__ah_val2 = strada_new_int(35); StradaValue *__ah_val3 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
#line 122 "lib/Nesso/test_nesso.strada"
StradaValue *id2 = strada_method_call(n, "save", strada_pack_args(1, u2));
({ StradaValue *__arg0 = strada_new_int(strada_to_num(id2) == ({ StradaValue *__num_tmp = strada_new_num(strada_to_num(id1) + 1.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; })); StradaValue *__arg1 = strada_new_str("second insert gets next id"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 126 "lib/Nesso/test_nesso.strada"
StradaValue *u3 = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("charlie"); StradaValue *__ah_val1 = strada_new_str("charlie@example.com"); StradaValue *__ah_val2 = strada_new_int(22); StradaValue *__ah_val3 = strada_new_int(0); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, u3)); strada_decref(__expr_tmp); });
({ StradaValue *__say_tmp = strada_new_str("Test: find"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 136 "lib/Nesso/test_nesso.strada"
StradaValue *found = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, id1)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_defined(found); StradaValue *__arg1 = strada_new_str("find returns a record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(found), "username"), "alice")); StradaValue *__arg1 = strada_new_str("find returns correct record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(found), "_model"), "users")); StradaValue *__arg1 = strada_new_str("find tags record with _model"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 141 "lib/Nesso/test_nesso.strada"
StradaValue *not_found = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_new_int(9999); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(!strada_to_bool(strada_defined(not_found))); StradaValue *__arg1 = strada_new_str("find returns undef for missing id"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: save (update)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
({ StradaValue *__hset_v = strada_new_str("alice_new@example.com"); strada_hash_set(strada_deref_hash(found), "email", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__hset_v = strada_new_int(29); strada_hash_set(strada_deref_hash(found), "age", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, found)); strada_decref(__expr_tmp); });
#line 150 "lib/Nesso/test_nesso.strada"
StradaValue *updated = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, id1)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(updated), "email"), "alice_new@example.com")); StradaValue *__arg1 = strada_new_str("update changes email"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(updated), "age")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 29.0); StradaValue *__arg1 = strada_new_str("update changes age"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(updated), "username"), "alice")); StradaValue *__arg1 = strada_new_str("update preserves unchanged fields"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: find_by"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 157 "lib/Nesso/test_nesso.strada"
StradaValue *by_name = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("bob"); StradaValue *__ah_hash = strada_anon_hash(1, "username", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "find_by", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_defined(by_name); StradaValue *__arg1 = strada_new_str("find_by returns a record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(by_name), "email"), "bob@example.com")); StradaValue *__arg1 = strada_new_str("find_by finds correct record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 161 "lib/Nesso/test_nesso.strada"
StradaValue *by_missing = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("nonexistent"); StradaValue *__ah_hash = strada_anon_hash(1, "username", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "find_by", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(!strada_to_bool(strada_defined(by_missing))); StradaValue *__arg1 = strada_new_str("find_by returns undef for no match"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: where"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 166 "lib/Nesso/test_nesso.strada"
StradaValue *active = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(1, "active", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "where", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(active)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 2.0); StradaValue *__arg1 = strada_new_str("where returns matching records"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 169 "lib/Nesso/test_nesso.strada"
StradaValue *inactive = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_int(0); StradaValue *__ah_hash = strada_anon_hash(1, "active", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "where", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(inactive)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("where with active=0 returns 1 record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(strada_array_get(strada_deref_array(inactive), 0)), "username"), "charlie")); StradaValue *__arg1 = strada_new_str("where returns correct inactive user"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: where with directives"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 175 "lib/Nesso/test_nesso.strada"
StradaValue *limited = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_int(1); StradaValue *__ah_val1 = strada_new_str("username ASC"); StradaValue *__ah_val2 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(3, "active", __ah_val0, "_order", __ah_val1, "_limit", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "where", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(limited)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("where with _limit returns limited results"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(strada_array_get(strada_deref_array(limited), 0)), "username"), "alice")); StradaValue *__arg1 = strada_new_str("where with _order sorts correctly"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: all"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 185 "lib/Nesso/test_nesso.strada"
StradaValue *all_users = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "all", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(all_users)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 3.0); StradaValue *__arg1 = strada_new_str("all returns all records"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: count"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 190 "lib/Nesso/test_nesso.strada"
StradaValue *total = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_to_num(total) == 3.0); StradaValue *__arg1 = strada_new_str("count with empty conditions returns total"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 193 "lib/Nesso/test_nesso.strada"
StradaValue *active_count = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(1, "active", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_to_num(active_count) == 2.0); StradaValue *__arg1 = strada_new_str("count with condition returns correct count"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: columns"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 198 "lib/Nesso/test_nesso.strada"
StradaValue *cols = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "columns", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(cols)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 5.0); StradaValue *__arg1 = strada_new_str("columns returns correct number of columns"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: query"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 203 "lib/Nesso/test_nesso.strada"
StradaValue *rows = ({ StradaValue *__meth_arg_0 = strada_new_str("SELECT username FROM users WHERE age > ? ORDER BY username"); StradaValue *__meth_arg_1 = ({ StradaValue *__aa_el0 = strada_new_int(25); StradaValue *__aa_arr = strada_anon_array(1, __aa_el0); strada_decref(__aa_el0); __aa_arr; }); StradaValue *__meth_res = strada_method_call(n, "query", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(rows)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 2.0); StradaValue *__arg1 = strada_new_str("query returns correct number of rows"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(strada_array_get(strada_deref_array(rows), 0)), "username"), "alice")); StradaValue *__arg1 = strada_new_str("query returns correct data"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: delete"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 209 "lib/Nesso/test_nesso.strada"
StradaValue *to_delete = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(u3), "id"))); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "delete", strada_pack_args(1, to_delete)); strada_decref(__expr_tmp); });
#line 211 "lib/Nesso/test_nesso.strada"
StradaValue *after_delete = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(u3), "id"))); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(!strada_to_bool(strada_defined(after_delete))); StradaValue *__arg1 = strada_new_str("delete removes the record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 2.0); StradaValue *__arg1 = strada_new_str("count decreases after delete"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: transaction (commit)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 218 "lib/Nesso/test_nesso.strada"
StradaValue *acct1 = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("alice"); StradaValue *__ah_val1 = strada_new_int(1000); StradaValue *__ah_hash = strada_anon_hash(2, "owner", __ah_val0, "balance", __ah_val1); strada_decref(__ah_val0); strada_decref(__ah_val1); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
#line 219 "lib/Nesso/test_nesso.strada"
StradaValue *acct2 = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("bob"); StradaValue *__ah_val1 = strada_new_int(500); StradaValue *__ah_hash = strada_anon_hash(2, "owner", __ah_val0, "balance", __ah_val1); strada_decref(__ah_val0); strada_decref(__ah_val1); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, acct1)); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, acct2)); strada_decref(__expr_tmp); });
#line 223 "lib/Nesso/test_nesso.strada"
StradaValue *transfer = strada_closure_new((void*)&__anon_func_0, 0, 3, (StradaValue**[]){&n, &acct1, &acct2});
({ StradaValue *__expr_tmp = strada_method_call(n, "transaction", strada_pack_args(1, transfer)); strada_decref(__expr_tmp); });
#line 233 "lib/Nesso/test_nesso.strada"
StradaValue *a_after = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(acct1), "id"))); strada_decref(__meth_arg_0); __meth_res; });
#line 234 "lib/Nesso/test_nesso.strada"
StradaValue *b_after = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(acct2), "id"))); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(a_after), "balance")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 900.0); StradaValue *__arg1 = strada_new_str("transaction commit: balance decreased"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(b_after), "balance")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 600.0); StradaValue *__arg1 = strada_new_str("transaction commit: balance increased"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: transaction (rollback)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 240 "lib/Nesso/test_nesso.strada"
StradaValue *rolled_back = strada_new_int(0);
if (setjmp(*STRADA_TRY_PUSH()) == 0) {
#line 242 "lib/Nesso/test_nesso.strada"
    StradaValue *bad_transfer = strada_closure_new((void*)&__anon_func_1, 0, 2, (StradaValue**[]){&n, &acct1});
    ({ StradaValue *__expr_tmp = strada_method_call(n, "transaction", strada_pack_args(1, bad_transfer)); strada_decref(__expr_tmp); });
    STRADA_TRY_POP();
    strada_decref(bad_transfer);
} else {
    STRADA_TRY_POP();
    StradaValue *__strada_exc = strada_get_exception();
    {
        StradaValue *e = __strada_exc;
        ({ StradaValue *__old = rolled_back; rolled_back = strada_new_int(1); strada_decref(__old); rolled_back; });
        ({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(e, "insufficient funds")); StradaValue *__arg1 = strada_new_str("transaction rollback: exception propagated"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
        strada_decref(e);
    }
}
({ StradaValue *__arg0 = strada_new_int(strada_to_num(rolled_back) == 1.0); StradaValue *__arg1 = strada_new_str("transaction rollback: catch block executed"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 255 "lib/Nesso/test_nesso.strada"
StradaValue *a_still = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(acct1), "id"))); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(a_still), "balance")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 900.0); StradaValue *__arg1 = strada_new_str("transaction rollback: balance unchanged"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: relationships (has_many)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 262 "lib/Nesso/test_nesso.strada"
StradaValue *u_alice = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, id1)); strada_decref(__meth_arg_0); __meth_res; });
#line 263 "lib/Nesso/test_nesso.strada"
StradaValue *u_bob = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, id2)); strada_decref(__meth_arg_0); __meth_res; });
#line 266 "lib/Nesso/test_nesso.strada"
StradaValue *p1 = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val1 = strada_new_str("Alice Post 1"); StradaValue *__ah_val2 = strada_new_str("Hello"); StradaValue *__ah_hash = strada_anon_hash(3, "user_id", id1, "title", __ah_val1, "body", __ah_val2); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, p1)); strada_decref(__expr_tmp); });
#line 268 "lib/Nesso/test_nesso.strada"
StradaValue *p2 = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val1 = strada_new_str("Alice Post 2"); StradaValue *__ah_val2 = strada_new_str("World"); StradaValue *__ah_hash = strada_anon_hash(3, "user_id", id1, "title", __ah_val1, "body", __ah_val2); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, p2)); strada_decref(__expr_tmp); });
#line 270 "lib/Nesso/test_nesso.strada"
StradaValue *p3 = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val1 = strada_new_str("Bob Post 1"); StradaValue *__ah_val2 = strada_new_str("Hi"); StradaValue *__ah_hash = strada_anon_hash(3, "user_id", id2, "title", __ah_val1, "body", __ah_val2); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, p3)); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_new_str("posts"); StradaValue *__meth_arg_2 = strada_new_str("user_id"); StradaValue *__meth_res = strada_method_call(n, "has_many", strada_pack_args(3, __meth_arg_0, __meth_arg_1, __meth_arg_2)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); strada_decref(__meth_arg_2); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = strada_new_str("author"); StradaValue *__meth_arg_2 = strada_new_str("users"); StradaValue *__meth_arg_3 = strada_new_str("user_id"); StradaValue *__meth_res = strada_method_call(n, "belongs_to", strada_pack_args(4, __meth_arg_0, __meth_arg_1, __meth_arg_2, __meth_arg_3)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); strada_decref(__meth_arg_2); strada_decref(__meth_arg_3); __meth_res; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_new_str("profile"); StradaValue *__meth_arg_2 = strada_new_str("profiles"); StradaValue *__meth_arg_3 = strada_new_str("user_id"); StradaValue *__meth_res = strada_method_call(n, "has_one", strada_pack_args(4, __meth_arg_0, __meth_arg_1, __meth_arg_2, __meth_arg_3)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); strada_decref(__meth_arg_2); strada_decref(__meth_arg_3); __meth_res; }); strada_decref(__expr_tmp); });
#line 279 "lib/Nesso/test_nesso.strada"
StradaValue *alice_posts = ({ StradaValue *__meth_arg_1 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_alice, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(alice_posts)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 2.0); StradaValue *__arg1 = strada_new_str("has_many: alice has 2 posts"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 282 "lib/Nesso/test_nesso.strada"
StradaValue *bob_posts = ({ StradaValue *__meth_arg_1 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_bob, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(bob_posts)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("has_many: bob has 1 post"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(strada_array_get(strada_deref_array(bob_posts), 0)), "title"), "Bob Post 1")); StradaValue *__arg1 = strada_new_str("has_many: bob post has correct title"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: relationships (belongs_to)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 288 "lib/Nesso/test_nesso.strada"
StradaValue *p1_found = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(p1), "id"))); strada_decref(__meth_arg_0); __meth_res; });
#line 289 "lib/Nesso/test_nesso.strada"
StradaValue *author = ({ StradaValue *__meth_arg_1 = strada_new_str("author"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, p1_found, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_defined(author); StradaValue *__arg1 = strada_new_str("belongs_to: author found"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(author), "username"), "alice")); StradaValue *__arg1 = strada_new_str("belongs_to: correct author"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 293 "lib/Nesso/test_nesso.strada"
StradaValue *p3_found = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(p3), "id"))); strada_decref(__meth_arg_0); __meth_res; });
#line 294 "lib/Nesso/test_nesso.strada"
StradaValue *author2 = ({ StradaValue *__meth_arg_1 = strada_new_str("author"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, p3_found, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(author2), "username"), "bob")); StradaValue *__arg1 = strada_new_str("belongs_to: bob is author of his post"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: relationships (has_one)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 301 "lib/Nesso/test_nesso.strada"
StradaValue *no_profile = ({ StradaValue *__meth_arg_1 = strada_new_str("profile"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_alice, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(!strada_to_bool(strada_defined(no_profile))); StradaValue *__arg1 = strada_new_str("has_one: returns undef when no profile"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 305 "lib/Nesso/test_nesso.strada"
StradaValue *prof = ({ StradaValue *__meth_arg_0 = strada_new_str("profiles"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val1 = strada_new_str("I am Alice"); StradaValue *__ah_hash = strada_anon_hash(2, "user_id", id1, "bio", __ah_val1); strada_decref(__ah_val1); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n, "save", strada_pack_args(1, prof)); strada_decref(__expr_tmp); });
#line 308 "lib/Nesso/test_nesso.strada"
StradaValue *alice_profile = ({ StradaValue *__meth_arg_1 = strada_new_str("profile"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_alice, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_defined(alice_profile); StradaValue *__arg1 = strada_new_str("has_one: profile found after creation"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(alice_profile), "bio"), "I am Alice")); StradaValue *__arg1 = strada_new_str("has_one: correct bio"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 313 "lib/Nesso/test_nesso.strada"
StradaValue *bob_profile = ({ StradaValue *__meth_arg_1 = strada_new_str("profile"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_bob, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(!strada_to_bool(strada_defined(bob_profile))); StradaValue *__arg1 = strada_new_str("has_one: bob has no profile"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: relationships (unknown relation)"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 318 "lib/Nesso/test_nesso.strada"
StradaValue *threw = strada_new_int(0);
if (setjmp(*STRADA_TRY_PUSH()) == 0) {
    ({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_1 = strada_new_str("nonexistent"); StradaValue *__meth_res = strada_method_call(n, "related", strada_pack_args(2, u_alice, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
    STRADA_TRY_POP();
} else {
    STRADA_TRY_POP();
    StradaValue *__strada_exc = strada_get_exception();
    {
        StradaValue *e = __strada_exc;
        ({ StradaValue *__old = threw; threw = strada_new_int(1); strada_decref(__old); threw; });
        ({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(e, "Nesso: unknown relation 'nonexistent' on model 'users'")); StradaValue *__arg1 = strada_new_str("related throws on unknown relation"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
        strada_decref(e);
    }
}
({ StradaValue *__arg0 = strada_new_int(strada_to_num(threw) == 1.0); StradaValue *__arg1 = strada_new_str("related throws for unknown relation name"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: clone"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 329 "lib/Nesso/test_nesso.strada"
StradaValue *db2 = ({ StradaValue *__arg0 = strada_new_str("dbi:SQLite::memory:"); StradaValue *__arg1 = strada_new_str(""); StradaValue *__arg2 = strada_new_str(""); StradaValue *__call_result = DBI_connect(__arg0, __arg1, __arg2); strada_decref(__arg0); strada_decref(__arg1); strada_decref(__arg2); __call_result; });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT, age INTEGER, active INTEGER DEFAULT 1)"); StradaValue *__call_result = DBI_do_sql(db2, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE posts (id INTEGER PRIMARY KEY, user_id INTEGER, title TEXT, body TEXT)"); StradaValue *__call_result = DBI_do_sql(db2, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE profiles (id INTEGER PRIMARY KEY, user_id INTEGER, bio TEXT)"); StradaValue *__call_result = DBI_do_sql(db2, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
#line 334 "lib/Nesso/test_nesso.strada"
StradaValue *n2 = strada_method_call(n, "clone", strada_pack_args(1, db2));
#line 337 "lib/Nesso/test_nesso.strada"
StradaValue *clone_cols = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n2, "columns", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(clone_cols)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 5.0); StradaValue *__arg1 = strada_new_str("clone: schemas copied"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 341 "lib/Nesso/test_nesso.strada"
StradaValue *clone_users = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n2, "all", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(clone_users)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0); StradaValue *__arg1 = strada_new_str("clone: new db is empty"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 345 "lib/Nesso/test_nesso.strada"
StradaValue *cu = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("clone_user"); StradaValue *__ah_val1 = strada_new_str("c@c.com"); StradaValue *__ah_val2 = strada_new_int(99); StradaValue *__ah_val3 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n2, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n2, "save", strada_pack_args(1, cu)); strada_decref(__expr_tmp); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n2, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("clone: insert into clone works"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 2.0); StradaValue *__arg1 = strada_new_str("clone: original unaffected"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 351 "lib/Nesso/test_nesso.strada"
StradaValue *clone_u = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n2, "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash(cu), "id"))); strada_decref(__meth_arg_0); __meth_res; });
#line 352 "lib/Nesso/test_nesso.strada"
StradaValue *clone_posts = ({ StradaValue *__meth_arg_1 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(n2, "related", strada_pack_args(2, clone_u, __meth_arg_1)); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(clone_posts)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0); StradaValue *__arg1 = strada_new_str("clone: relationships work (no posts yet)"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
DBI_disconnect(db2);
({ StradaValue *__say_tmp = strada_new_str("Test: set_db"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 359 "lib/Nesso/test_nesso.strada"
StradaValue *db3 = ({ StradaValue *__arg0 = strada_new_str("dbi:SQLite::memory:"); StradaValue *__arg1 = strada_new_str(""); StradaValue *__arg2 = strada_new_str(""); StradaValue *__call_result = DBI_connect(__arg0, __arg1, __arg2); strada_decref(__arg0); strada_decref(__arg1); strada_decref(__arg2); __call_result; });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT, age INTEGER, active INTEGER DEFAULT 1)"); StradaValue *__call_result = DBI_do_sql(db3, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
#line 363 "lib/Nesso/test_nesso.strada"
StradaValue *n3 = Nesso_new(db3);
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("users"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("username"); StradaValue *__aa_el2 = strada_new_str("email"); StradaValue *__aa_el3 = strada_new_str("age"); StradaValue *__aa_el4 = strada_new_str("active"); StradaValue *__aa_arr = strada_anon_array(5, __aa_el0, __aa_el1, __aa_el2, __aa_el3, __aa_el4); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); strada_decref(__aa_el3); strada_decref(__aa_el4); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_hash = strada_anon_hash(3, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n3, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 370 "lib/Nesso/test_nesso.strada"
StradaValue *su = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("swap_user"); StradaValue *__ah_val1 = strada_new_str("s@s.com"); StradaValue *__ah_val2 = strada_new_int(50); StradaValue *__ah_val3 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n3, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(n3, "save", strada_pack_args(1, su)); strada_decref(__expr_tmp); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n3, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("set_db: initial db has 1 user"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 375 "lib/Nesso/test_nesso.strada"
StradaValue *db4 = ({ StradaValue *__arg0 = strada_new_str("dbi:SQLite::memory:"); StradaValue *__arg1 = strada_new_str(""); StradaValue *__arg2 = strada_new_str(""); StradaValue *__call_result = DBI_connect(__arg0, __arg1, __arg2); strada_decref(__arg0); strada_decref(__arg1); strada_decref(__arg2); __call_result; });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT, age INTEGER, active INTEGER DEFAULT 1)"); StradaValue *__call_result = DBI_do_sql(db4, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = strada_method_call(n3, "set_db", strada_pack_args(1, db4)); strada_decref(__expr_tmp); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n3, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0); StradaValue *__arg1 = strada_new_str("set_db: swapped db is empty"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 381 "lib/Nesso/test_nesso.strada"
StradaValue *got_db = strada_method_call(n3, "get_db", strada_pack_args(0));
({ StradaValue *__arg0 = strada_defined(got_db); StradaValue *__arg1 = strada_new_str("get_db: returns db handle"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
DBI_disconnect(db3);
DBI_disconnect(db4);
({ StradaValue *__say_tmp = strada_new_str("Test: ActiveRecord-style methods"); strada_say(__say_tmp); strada_decref(__say_tmp); });
#line 391 "lib/Nesso/test_nesso.strada"
StradaValue *ar_user = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("david"); StradaValue *__ah_val1 = strada_new_str("david@example.com"); StradaValue *__ah_val2 = strada_new_int(40); StradaValue *__ah_val3 = strada_new_int(1); StradaValue *__ah_hash = strada_anon_hash(4, "username", __ah_val0, "email", __ah_val1, "age", __ah_val2, "active", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_method_call(ar_user, "is_new", strada_pack_args(0)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("is_new: true before save"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 393 "lib/Nesso/test_nesso.strada"
StradaValue *ar_id = strada_method_call(ar_user, "save", strada_pack_args(0));
({ StradaValue *__arg0 = strada_new_int(strada_to_num(ar_id) > 0.0); StradaValue *__arg1 = strada_new_str("record->save() inserts and returns id"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_method_call(ar_user, "is_new", strada_pack_args(0)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0); StradaValue *__arg1 = strada_new_str("is_new: false after save"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_method_call(ar_user, "id", strada_pack_args(0)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == strada_to_num(ar_id)); StradaValue *__arg1 = strada_new_str("record->id() returns primary key"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = ({ StradaValue *__cmp_l = strada_method_call(ar_user, "model", strada_pack_args(0)); int __cmp_r = strada_str_eq_lit(__cmp_l, "users"); strada_decref(__cmp_l); strada_new_int(__cmp_r); }); StradaValue *__arg1 = strada_new_str("record->model() returns model name"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__hset_v = strada_new_str("david_updated@example.com"); strada_hash_set(strada_deref_hash(ar_user), "email", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__expr_tmp = strada_method_call(ar_user, "save", strada_pack_args(0)); strada_decref(__expr_tmp); });
#line 402 "lib/Nesso/test_nesso.strada"
StradaValue *ar_check = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, ar_id)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(ar_check), "email"), "david_updated@example.com")); StradaValue *__arg1 = strada_new_str("record->save() updates"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = ({ StradaValue *__ah_val0 = strada_new_int(41); StradaValue *__ah_val1 = strada_new_str("david41@example.com"); StradaValue *__ah_hash = strada_anon_hash(2, "age", __ah_val0, "email", __ah_val1); strada_decref(__ah_val0); strada_decref(__ah_val1); __ah_hash; }); StradaValue *__meth_res = strada_method_call(ar_user, "update", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; }); strada_decref(__expr_tmp); });
#line 407 "lib/Nesso/test_nesso.strada"
StradaValue *ar_check2 = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, ar_id)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(ar_check2), "age")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 41.0); StradaValue *__arg1 = strada_new_str("record->update() changes age"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(ar_check2), "email"), "david41@example.com")); StradaValue *__arg1 = strada_new_str("record->update() changes email"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__hset_v = strada_new_str("not_saved@example.com"); strada_hash_set(strada_deref_hash(ar_user), "email", __hset_v); strada_decref(__hset_v); });
({ StradaValue *__expr_tmp = strada_method_call(ar_user, "reload", strada_pack_args(0)); strada_decref(__expr_tmp); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(ar_user), "email"), "david41@example.com")); StradaValue *__arg1 = strada_new_str("record->reload() restores from db"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 417 "lib/Nesso/test_nesso.strada"
StradaValue *ar_post = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val1 = strada_new_str("David's Post"); StradaValue *__ah_val2 = strada_new_str("Content"); StradaValue *__ah_hash = strada_anon_hash(3, "user_id", ar_id, "title", __ah_val1, "body", __ah_val2); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(ar_post, "save", strada_pack_args(0)); strada_decref(__expr_tmp); });
#line 419 "lib/Nesso/test_nesso.strada"
StradaValue *ar_posts = ({ StradaValue *__meth_arg_0 = strada_new_str("posts"); StradaValue *__meth_res = strada_method_call(ar_user, "related", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(ar_posts)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("record->related() returns related records"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(strada_str_eq_lit(strada_hash_get(strada_deref_hash(strada_array_get(strada_deref_array(ar_posts), 0)), "title"), "David's Post")); StradaValue *__arg1 = strada_new_str("record->related() correct data"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 424 "lib/Nesso/test_nesso.strada"
StradaValue *pre_count = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__expr_tmp = strada_method_call(ar_user, "delete", strada_pack_args(0)); strada_decref(__expr_tmp); });
#line 426 "lib/Nesso/test_nesso.strada"
StradaValue *post_count = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "count", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(strada_to_num(post_count) == ({ StradaValue *__num_tmp = strada_new_num(strada_to_num(pre_count) - 1.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; })); StradaValue *__arg1 = strada_new_str("record->delete() removes record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__say_tmp = strada_new_str("Test: custom model classes"); strada_say(__say_tmp); strada_decref(__say_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__arg1 = strada_new_str("CREATE TABLE admins (id INTEGER PRIMARY KEY, username TEXT, email TEXT, access_level INTEGER)"); StradaValue *__call_result = DBI_do_sql(db, __arg1); strada_decref(__arg1); __call_result; }); strada_decref(__expr_tmp); });
({ StradaValue *__expr_tmp = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("admins"); StradaValue *__ah_val1 = ({ StradaValue *__aa_el0 = strada_new_str("id"); StradaValue *__aa_el1 = strada_new_str("username"); StradaValue *__aa_el2 = strada_new_str("email"); StradaValue *__aa_el3 = strada_new_str("access_level"); StradaValue *__aa_arr = strada_anon_array(4, __aa_el0, __aa_el1, __aa_el2, __aa_el3); strada_decref(__aa_el0); strada_decref(__aa_el1); strada_decref(__aa_el2); strada_decref(__aa_el3); __aa_arr; }); StradaValue *__ah_val2 = strada_new_str("id"); StradaValue *__ah_val3 = strada_new_str("AdminUser"); StradaValue *__ah_hash = strada_anon_hash(4, "table", __ah_val0, "columns", __ah_val1, "primary", __ah_val2, "class", __ah_val3); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); strada_decref(__ah_val3); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "define", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; }); strada_decref(__expr_tmp); });
#line 444 "lib/Nesso/test_nesso.strada"
StradaValue *admin = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("superadmin"); StradaValue *__ah_val1 = strada_new_str("admin@example.com"); StradaValue *__ah_val2 = strada_new_int(10); StradaValue *__ah_hash = strada_anon_hash(3, "username", __ah_val0, "email", __ah_val1, "access_level", __ah_val2); strada_decref(__ah_val0); strada_decref(__ah_val1); strada_decref(__ah_val2); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "create", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(admin, "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: create returns AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(admin, "Nesso::Record")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: AdminUser isa Nesso::Record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 449 "lib/Nesso/test_nesso.strada"
StradaValue *admin_id = strada_method_call(admin, "save", strada_pack_args(0));
({ StradaValue *__arg0 = strada_new_int(strada_to_num(admin_id) > 0.0); StradaValue *__arg1 = strada_new_str("custom class: inherited save() works"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = ({ StradaValue *__cmp_l = strada_method_call(admin, "model", strada_pack_args(0)); int __cmp_r = strada_str_eq_lit(__cmp_l, "admins"); strada_decref(__cmp_l); strada_new_int(__cmp_r); }); StradaValue *__arg1 = strada_new_str("custom class: inherited model() works"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_method_call(admin, "is_super_admin", strada_pack_args(0)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: custom is_super_admin() works"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 457 "lib/Nesso/test_nesso.strada"
StradaValue *found_admin = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, admin_id)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(found_admin, "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: find returns AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_method_call(found_admin, "is_super_admin", strada_pack_args(0)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: found record has custom methods"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 462 "lib/Nesso/test_nesso.strada"
StradaValue *all_admins = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_arg_1 = strada_anon_hash(0); StradaValue *__meth_res = strada_method_call(n, "where", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_size(all_admins)); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: where returns array"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(strada_array_get(strada_deref_array(all_admins), 0), "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: where results are AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 467 "lib/Nesso/test_nesso.strada"
StradaValue *all_admins2 = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_res = strada_method_call(n, "all", strada_pack_args(1, __meth_arg_0)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(strada_array_get(strada_deref_array(all_admins2), 0), "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: all results are AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 471 "lib/Nesso/test_nesso.strada"
StradaValue *admin_by_name = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_arg_1 = ({ StradaValue *__ah_val0 = strada_new_str("superadmin"); StradaValue *__ah_hash = strada_anon_hash(1, "username", __ah_val0); strada_decref(__ah_val0); __ah_hash; }); StradaValue *__meth_res = strada_method_call(n, "find_by", strada_pack_args(2, __meth_arg_0, __meth_arg_1)); strada_decref(__meth_arg_0); strada_decref(__meth_arg_1); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(admin_by_name, "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("custom class: find_by returns AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__expr_tmp = strada_method_call(found_admin, "promote", strada_pack_args(0)); strada_decref(__expr_tmp); });
#line 476 "lib/Nesso/test_nesso.strada"
StradaValue *promoted = ({ StradaValue *__meth_arg_0 = strada_new_str("admins"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, admin_id)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(promoted), "access_level")) + 0.0); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 11.0); StradaValue *__arg1 = strada_new_str("custom class: promote() increases access_level"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
#line 480 "lib/Nesso/test_nesso.strada"
StradaValue *regular_user = ({ StradaValue *__meth_arg_0 = strada_new_str("users"); StradaValue *__meth_res = strada_method_call(n, "find", strada_pack_args(2, __meth_arg_0, id1)); strada_decref(__meth_arg_0); __meth_res; });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(regular_user, "Nesso::Record")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 1.0); StradaValue *__arg1 = strada_new_str("regular model: still Nesso::Record"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
({ StradaValue *__arg0 = strada_new_int(({ StradaValue *__num_tmp = strada_new_int(strada_isa(regular_user, "AdminUser")); double __num_val = strada_to_num(__num_tmp); strada_decref(__num_tmp); __num_val; }) == 0.0); StradaValue *__arg1 = strada_new_str("regular model: not AdminUser"); ok(__arg0, __arg1); strada_decref(__arg0); strada_decref(__arg1); });
DBI_disconnect(db);
({ StradaValue *__say_tmp = strada_new_str(""); strada_say(__say_tmp); strada_decref(__say_tmp); });
({ StradaValue *__say_tmp = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = ({ StradaValue *__concat_l = strada_new_str("Results: "); StradaValue *__concat_res = strada_concat_sv(__concat_l, g_pass); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" passed, "); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); StradaValue *__concat_res = strada_concat_sv(__concat_l, g_fail); strada_decref(__concat_l); __concat_res; }); StradaValue *__concat_r = strada_new_str(" failed"); StradaValue *__concat_res = strada_concat_sv(__concat_l, __concat_r); strada_decref(__concat_l); strada_decref(__concat_r); __concat_res; }); strada_say(__say_tmp); strada_decref(__say_tmp); });
if ((strada_to_num(g_fail) == 0.0)) {
    ({ StradaValue *__say_tmp = strada_new_str("PASS: All Nesso tests passed"); strada_say(__say_tmp); strada_decref(__say_tmp); });
} else {
    ({ StradaValue *__say_tmp = strada_new_str("FAIL: Some Nesso tests failed"); strada_say(__say_tmp); strada_decref(__say_tmp); });
}
{ int __main_ret = strada_to_int(g_fail);
    strada_decref(db);
    strada_decref(n);
    strada_decref(u1);
    strada_decref(id1);
    strada_decref(u2);
    strada_decref(id2);
    strada_decref(u3);
    strada_decref(found);
    strada_decref(not_found);
    strada_decref(updated);
    strada_decref(by_name);
    strada_decref(by_missing);
    strada_decref(active);
    strada_decref(inactive);
    strada_decref(limited);
    strada_decref(all_users);
    strada_decref(total);
    strada_decref(active_count);
    strada_decref(cols);
    strada_decref(rows);
    strada_decref(to_delete);
    strada_decref(after_delete);
    strada_decref(acct1);
    strada_decref(acct2);
    strada_decref(transfer);
    strada_decref(a_after);
    strada_decref(b_after);
    strada_decref(rolled_back);
    strada_decref(a_still);
    strada_decref(u_alice);
    strada_decref(u_bob);
    strada_decref(p1);
    strada_decref(p2);
    strada_decref(p3);
    strada_decref(alice_posts);
    strada_decref(bob_posts);
    strada_decref(p1_found);
    strada_decref(author);
    strada_decref(p3_found);
    strada_decref(author2);
    strada_decref(no_profile);
    strada_decref(prof);
    strada_decref(alice_profile);
    strada_decref(bob_profile);
    strada_decref(threw);
    strada_decref(db2);
    strada_decref(n2);
    strada_decref(clone_cols);
    strada_decref(clone_users);
    strada_decref(cu);
    strada_decref(clone_u);
    strada_decref(clone_posts);
    strada_decref(db3);
    strada_decref(n3);
    strada_decref(su);
    strada_decref(db4);
    strada_decref(got_db);
    strada_decref(ar_user);
    strada_decref(ar_id);
    strada_decref(ar_check);
    strada_decref(ar_check2);
    strada_decref(ar_post);
    strada_decref(ar_posts);
    strada_decref(pre_count);
    strada_decref(post_count);
    strada_decref(admin);
    strada_decref(admin_id);
    strada_decref(found_admin);
    strada_decref(all_admins);
    strada_decref(all_admins2);
    strada_decref(admin_by_name);
    strada_decref(promoted);
    strada_decref(regular_user);
    return __main_ret; }
strada_decref(db);
strada_decref(n);
strada_decref(u1);
strada_decref(id1);
strada_decref(u2);
strada_decref(id2);
strada_decref(u3);
strada_decref(found);
strada_decref(not_found);
strada_decref(updated);
strada_decref(by_name);
strada_decref(by_missing);
strada_decref(active);
strada_decref(inactive);
strada_decref(limited);
strada_decref(all_users);
strada_decref(total);
strada_decref(active_count);
strada_decref(cols);
strada_decref(rows);
strada_decref(to_delete);
strada_decref(after_delete);
strada_decref(acct1);
strada_decref(acct2);
strada_decref(transfer);
strada_decref(a_after);
strada_decref(b_after);
strada_decref(rolled_back);
strada_decref(a_still);
strada_decref(u_alice);
strada_decref(u_bob);
strada_decref(p1);
strada_decref(p2);
strada_decref(p3);
strada_decref(alice_posts);
strada_decref(bob_posts);
strada_decref(p1_found);
strada_decref(author);
strada_decref(p3_found);
strada_decref(author2);
strada_decref(no_profile);
strada_decref(prof);
strada_decref(alice_profile);
strada_decref(bob_profile);
strada_decref(threw);
strada_decref(db2);
strada_decref(n2);
strada_decref(clone_cols);
strada_decref(clone_users);
strada_decref(cu);
strada_decref(clone_u);
strada_decref(clone_posts);
strada_decref(db3);
strada_decref(n3);
strada_decref(su);
strada_decref(db4);
strada_decref(got_db);
strada_decref(ar_user);
strada_decref(ar_id);
strada_decref(ar_check);
strada_decref(ar_check2);
strada_decref(ar_post);
strada_decref(ar_posts);
strada_decref(pre_count);
strada_decref(post_count);
strada_decref(admin);
strada_decref(admin_id);
strada_decref(found_admin);
strada_decref(all_admins);
strada_decref(all_admins2);
strada_decref(admin_by_name);
strada_decref(promoted);
strada_decref(regular_user);
}


/* Anonymous function definitions */
StradaValue* __anon_func_0(StradaValue ***__captures) {
#line 224 "lib/Nesso/test_nesso.strada"
    StradaValue *a = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call((*__captures[0]), "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash((*__captures[1])), "id"))); strada_decref(__meth_arg_0); __meth_res; });
#line 225 "lib/Nesso/test_nesso.strada"
    StradaValue *b = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call((*__captures[0]), "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash((*__captures[2])), "id"))); strada_decref(__meth_arg_0); __meth_res; });
    ({ StradaValue *__hset_v = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(a), "balance")) - 100.0); strada_hash_set(strada_deref_hash(a), "balance", __hset_v); strada_decref(__hset_v); });
    ({ StradaValue *__hset_v = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(b), "balance")) + 100.0); strada_hash_set(strada_deref_hash(b), "balance", __hset_v); strada_decref(__hset_v); });
    ({ StradaValue *__expr_tmp = strada_method_call((*__captures[0]), "save", strada_pack_args(1, a)); strada_decref(__expr_tmp); });
    ({ StradaValue *__expr_tmp = strada_method_call((*__captures[0]), "save", strada_pack_args(1, b)); strada_decref(__expr_tmp); });
}

StradaValue* __anon_func_1(StradaValue ***__captures) {
#line 243 "lib/Nesso/test_nesso.strada"
    StradaValue *a = ({ StradaValue *__meth_arg_0 = strada_new_str("accounts"); StradaValue *__meth_res = strada_method_call((*__captures[0]), "find", strada_pack_args(2, __meth_arg_0, strada_hash_get(strada_deref_hash((*__captures[1])), "id"))); strada_decref(__meth_arg_0); __meth_res; });
    ({ StradaValue *__hset_v = strada_new_num(strada_to_num(strada_hash_get(strada_deref_hash(a), "balance")) - 9999.0); strada_hash_set(strada_deref_hash(a), "balance", __hset_v); strada_decref(__hset_v); });
    ({ StradaValue *__expr_tmp = strada_method_call((*__captures[0]), "save", strada_pack_args(1, a)); strada_decref(__expr_tmp); });
    strada_throw_value(strada_new_str("insufficient funds"));
}


/* OOP method dispatch helper */
static StradaValue* __strada_get_arg(StradaValue* args, int idx) {
    if (!args || args->type != STRADA_ARRAY) return NULL;
    if ((size_t)idx >= args->value.av->size) return NULL;
    return args->value.av->elements[idx];
}

/* OOP method wrappers for package DBI */
static StradaValue* __wrap_DBI_connect(StradaValue* self, StradaValue* args) {
    return DBI_connect(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_connect_attrs(StradaValue* self, StradaValue* args) {
    return DBI_connect_attrs(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1), __strada_get_arg(args, 2));
}

static StradaValue* __wrap_DBI_disconnect(StradaValue* self, StradaValue* args) {
    (void)args;
    DBI_disconnect(self);
    return strada_undef_static();
}

static StradaValue* __wrap_DBI_prepare(StradaValue* self, StradaValue* args) {
    return DBI_prepare(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_DBI__bind_params(StradaValue* self, StradaValue* args) {
    DBI__bind_params(self, __strada_get_arg(args, 0));
    return strada_undef_static();
}

static StradaValue* __wrap_DBI_execute(StradaValue* self, StradaValue* args) {
    return DBI_execute(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_DBI_exec(StradaValue* self, StradaValue* args) {
    return DBI_exec(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_do_sql(StradaValue* self, StradaValue* args) {
    return DBI_do_sql(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_DBI_fetchrow_array(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_fetchrow_array(self);
}

static StradaValue* __wrap_DBI_fetchrow_hashref(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_fetchrow_hashref(self);
}

static StradaValue* __wrap_DBI_fetchall_arrayref(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_fetchall_arrayref(self);
}

static StradaValue* __wrap_DBI_selectall_arrayref(StradaValue* self, StradaValue* args) {
    return DBI_selectall_arrayref(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_DBI_selectall_arrayref_bind(StradaValue* self, StradaValue* args) {
    return DBI_selectall_arrayref_bind(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_begin_work(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_begin_work(self);
}

static StradaValue* __wrap_DBI_commit(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_commit(self);
}

static StradaValue* __wrap_DBI_rollback(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_rollback(self);
}

static StradaValue* __wrap_DBI_quote(StradaValue* self, StradaValue* args) {
    return DBI_quote(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_DBI_last_insert_id(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_last_insert_id(self);
}

static StradaValue* __wrap_DBI_errstr(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_errstr(self);
}

static StradaValue* __wrap_DBI_err(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_err(self);
}

static StradaValue* __wrap_DBI_set_raise_error(StradaValue* self, StradaValue* args) {
    DBI_set_raise_error(self, __strada_get_arg(args, 0));
    return strada_undef_static();
}

static StradaValue* __wrap_DBI_finish(StradaValue* self, StradaValue* args) {
    (void)args;
    DBI_finish(self);
    return strada_undef_static();
}

static StradaValue* __wrap_DBI_rows(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_rows(self);
}

static StradaValue* __wrap_DBI_column_names(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_column_names(self);
}

static StradaValue* __wrap_DBI_ping(StradaValue* self, StradaValue* args) {
    (void)args;
    return DBI_ping(self);
}

static StradaValue* __wrap_DBI_selectall_hashref(StradaValue* self, StradaValue* args) {
    return DBI_selectall_hashref(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_selectrow_hashref(StradaValue* self, StradaValue* args) {
    return DBI_selectrow_hashref(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_selectcol(StradaValue* self, StradaValue* args) {
    return DBI_selectcol(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_DBI_insert_get_id(StradaValue* self, StradaValue* args) {
    return DBI_insert_get_id(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

/* OOP method registration initializer */
static int __DBI_oop_initialized = 0;
void __DBI_oop_init(void) {
    if (__DBI_oop_initialized) return;
    __DBI_oop_initialized = 1;

    strada_method_register("DBI", "connect", __wrap_DBI_connect);
    strada_method_register("DBI", "connect_attrs", __wrap_DBI_connect_attrs);
    strada_method_register("DBI", "disconnect", __wrap_DBI_disconnect);
    strada_method_register("DBI", "prepare", __wrap_DBI_prepare);
    strada_method_register("DBI", "_bind_params", __wrap_DBI__bind_params);
    strada_method_register("DBI", "execute", __wrap_DBI_execute);
    strada_method_register("DBI", "exec", __wrap_DBI_exec);
    strada_method_register("DBI", "do_sql", __wrap_DBI_do_sql);
    strada_method_register("DBI", "fetchrow_array", __wrap_DBI_fetchrow_array);
    strada_method_register("DBI", "fetchrow_hashref", __wrap_DBI_fetchrow_hashref);
    strada_method_register("DBI", "fetchall_arrayref", __wrap_DBI_fetchall_arrayref);
    strada_method_register("DBI", "selectall_arrayref", __wrap_DBI_selectall_arrayref);
    strada_method_register("DBI", "selectall_arrayref_bind", __wrap_DBI_selectall_arrayref_bind);
    strada_method_register("DBI", "begin_work", __wrap_DBI_begin_work);
    strada_method_register("DBI", "commit", __wrap_DBI_commit);
    strada_method_register("DBI", "rollback", __wrap_DBI_rollback);
    strada_method_register("DBI", "quote", __wrap_DBI_quote);
    strada_method_register("DBI", "last_insert_id", __wrap_DBI_last_insert_id);
    strada_method_register("DBI", "errstr", __wrap_DBI_errstr);
    strada_method_register("DBI", "err", __wrap_DBI_err);
    strada_method_register("DBI", "set_raise_error", __wrap_DBI_set_raise_error);
    strada_method_register("DBI", "finish", __wrap_DBI_finish);
    strada_method_register("DBI", "rows", __wrap_DBI_rows);
    strada_method_register("DBI", "column_names", __wrap_DBI_column_names);
    strada_method_register("DBI", "ping", __wrap_DBI_ping);
    strada_method_register("DBI", "selectall_hashref", __wrap_DBI_selectall_hashref);
    strada_method_register("DBI", "selectrow_hashref", __wrap_DBI_selectrow_hashref);
    strada_method_register("DBI", "selectcol", __wrap_DBI_selectcol);
    strada_method_register("DBI", "insert_get_id", __wrap_DBI_insert_get_id);
}

/* OOP method wrappers for package Nesso */
static StradaValue* __wrap_Nesso_log_sql(StradaValue* self, StradaValue* args) {
    Nesso_log_sql(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_get_schema(StradaValue* self, StradaValue* args) {
    return Nesso_get_schema(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_build_where_clause(StradaValue* self, StradaValue* args) {
    return Nesso_build_where_clause(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_wrap_record(StradaValue* self, StradaValue* args) {
    return Nesso_wrap_record(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_tag_rows(StradaValue* self, StradaValue* args) {
    return Nesso_tag_rows(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_new(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_new(self);
}

static StradaValue* __wrap_Nesso_set_db(StradaValue* self, StradaValue* args) {
    Nesso_set_db(self, __strada_get_arg(args, 0));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_get_db(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_get_db(self);
}

static StradaValue* __wrap_Nesso_set_debug(StradaValue* self, StradaValue* args) {
    Nesso_set_debug(self, __strada_get_arg(args, 0));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_get_debug(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_get_debug(self);
}

static StradaValue* __wrap_Nesso_define(StradaValue* self, StradaValue* args) {
    Nesso_define(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_columns(StradaValue* self, StradaValue* args) {
    return Nesso_columns(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_create(StradaValue* self, StradaValue* args) {
    return Nesso_create(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_save(StradaValue* self, StradaValue* args) {
    return Nesso_save(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_find(StradaValue* self, StradaValue* args) {
    return Nesso_find(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_find_by(StradaValue* self, StradaValue* args) {
    return Nesso_find_by(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_where(StradaValue* self, StradaValue* args) {
    return Nesso_where(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_all(StradaValue* self, StradaValue* args) {
    return Nesso_all(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_count(StradaValue* self, StradaValue* args) {
    return Nesso_count(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_delete(StradaValue* self, StradaValue* args) {
    return Nesso_delete(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_query(StradaValue* self, StradaValue* args) {
    return Nesso_query(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_transaction(StradaValue* self, StradaValue* args) {
    Nesso_transaction(self, __strada_get_arg(args, 0));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_has_many(StradaValue* self, StradaValue* args) {
    Nesso_has_many(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1), __strada_get_arg(args, 2));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_belongs_to(StradaValue* self, StradaValue* args) {
    Nesso_belongs_to(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1), __strada_get_arg(args, 2), __strada_get_arg(args, 3));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_has_one(StradaValue* self, StradaValue* args) {
    Nesso_has_one(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1), __strada_get_arg(args, 2), __strada_get_arg(args, 3));
    return strada_undef_static();
}

static StradaValue* __wrap_Nesso_related(StradaValue* self, StradaValue* args) {
    return Nesso_related(self, __strada_get_arg(args, 0), __strada_get_arg(args, 1));
}

static StradaValue* __wrap_Nesso_clone(StradaValue* self, StradaValue* args) {
    return Nesso_clone(self, __strada_get_arg(args, 0));
}

/* OOP method registration initializer */
static int __Nesso_oop_initialized = 0;
void __Nesso_oop_init(void) {
    if (__Nesso_oop_initialized) return;
    __Nesso_oop_initialized = 1;

    strada_method_register("Nesso", "log_sql", __wrap_Nesso_log_sql);
    strada_method_register("Nesso", "get_schema", __wrap_Nesso_get_schema);
    strada_method_register("Nesso", "build_where_clause", __wrap_Nesso_build_where_clause);
    strada_method_register("Nesso", "wrap_record", __wrap_Nesso_wrap_record);
    strada_method_register("Nesso", "tag_rows", __wrap_Nesso_tag_rows);
    strada_method_register("Nesso", "new", __wrap_Nesso_new);
    strada_method_register("Nesso", "set_db", __wrap_Nesso_set_db);
    strada_method_register("Nesso", "get_db", __wrap_Nesso_get_db);
    strada_method_register("Nesso", "set_debug", __wrap_Nesso_set_debug);
    strada_method_register("Nesso", "get_debug", __wrap_Nesso_get_debug);
    strada_method_register("Nesso", "define", __wrap_Nesso_define);
    strada_method_register("Nesso", "columns", __wrap_Nesso_columns);
    strada_method_register("Nesso", "create", __wrap_Nesso_create);
    strada_method_register("Nesso", "save", __wrap_Nesso_save);
    strada_method_register("Nesso", "find", __wrap_Nesso_find);
    strada_method_register("Nesso", "find_by", __wrap_Nesso_find_by);
    strada_method_register("Nesso", "where", __wrap_Nesso_where);
    strada_method_register("Nesso", "all", __wrap_Nesso_all);
    strada_method_register("Nesso", "count", __wrap_Nesso_count);
    strada_method_register("Nesso", "delete", __wrap_Nesso_delete);
    strada_method_register("Nesso", "query", __wrap_Nesso_query);
    strada_method_register("Nesso", "transaction", __wrap_Nesso_transaction);
    strada_method_register("Nesso", "has_many", __wrap_Nesso_has_many);
    strada_method_register("Nesso", "belongs_to", __wrap_Nesso_belongs_to);
    strada_method_register("Nesso", "has_one", __wrap_Nesso_has_one);
    strada_method_register("Nesso", "related", __wrap_Nesso_related);
    strada_method_register("Nesso", "clone", __wrap_Nesso_clone);
}

/* OOP method wrappers for package Nesso::Record */
static StradaValue* __wrap_Nesso_Record_save(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_save(self);
}

static StradaValue* __wrap_Nesso_Record_update(StradaValue* self, StradaValue* args) {
    return Nesso_Record_update(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_Record_delete(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_delete(self);
}

static StradaValue* __wrap_Nesso_Record_reload(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_reload(self);
}

static StradaValue* __wrap_Nesso_Record_related(StradaValue* self, StradaValue* args) {
    return Nesso_Record_related(self, __strada_get_arg(args, 0));
}

static StradaValue* __wrap_Nesso_Record_model(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_model(self);
}

static StradaValue* __wrap_Nesso_Record_id(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_id(self);
}

static StradaValue* __wrap_Nesso_Record_is_new(StradaValue* self, StradaValue* args) {
    (void)args;
    return Nesso_Record_is_new(self);
}

/* OOP method registration initializer */
static int __Nesso_Record_oop_initialized = 0;
void __Nesso_Record_oop_init(void) {
    if (__Nesso_Record_oop_initialized) return;
    __Nesso_Record_oop_initialized = 1;

    strada_method_register("Nesso::Record", "save", __wrap_Nesso_Record_save);
    strada_method_register("Nesso::Record", "update", __wrap_Nesso_Record_update);
    strada_method_register("Nesso::Record", "delete", __wrap_Nesso_Record_delete);
    strada_method_register("Nesso::Record", "reload", __wrap_Nesso_Record_reload);
    strada_method_register("Nesso::Record", "related", __wrap_Nesso_Record_related);
    strada_method_register("Nesso::Record", "model", __wrap_Nesso_Record_model);
    strada_method_register("Nesso::Record", "id", __wrap_Nesso_Record_id);
    strada_method_register("Nesso::Record", "is_new", __wrap_Nesso_Record_is_new);
}

/* OOP method wrappers for package AdminUser */
static StradaValue* __wrap_AdminUser_is_super_admin(StradaValue* self, StradaValue* args) {
    (void)args;
    return AdminUser_is_super_admin(self);
}

static StradaValue* __wrap_AdminUser_promote(StradaValue* self, StradaValue* args) {
    (void)args;
    AdminUser_promote(self);
    return strada_undef_static();
}

/* OOP method registration initializer */
static int __AdminUser_oop_initialized = 0;
void __AdminUser_oop_init(void) {
    if (__AdminUser_oop_initialized) return;
    __AdminUser_oop_initialized = 1;

    strada_method_register("AdminUser", "is_super_admin", __wrap_AdminUser_is_super_admin);
    strada_method_register("AdminUser", "promote", __wrap_AdminUser_promote);
}

/* Qualified name aliases for package main */
StradaValue* main__DBI_connect(StradaValue* dsn, StradaValue* username, StradaValue* password) { return DBI_connect(dsn, username, password); }
StradaValue* main__DBI_connect_attrs(StradaValue* dsn, StradaValue* username, StradaValue* password, StradaValue* attrs) { return DBI_connect_attrs(dsn, username, password, attrs); }
void main__DBI_disconnect(StradaValue* dbh) { return DBI_disconnect(dbh); }
StradaValue* main__DBI_prepare(StradaValue* dbh, StradaValue* sql) { return DBI_prepare(dbh, sql); }
void main__DBI__bind_params(StradaValue* sth_ptr, StradaValue* params) { return DBI__bind_params(sth_ptr, params); }
StradaValue* main__DBI_execute(StradaValue* sth, StradaValue* params) { return DBI_execute(sth, params); }
StradaValue* main__DBI_exec(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_exec(dbh, sql, params); }
StradaValue* main__DBI_do_sql(StradaValue* dbh, StradaValue* sql) { return DBI_do_sql(dbh, sql); }
StradaValue* main__DBI_fetchrow_array(StradaValue* sth) { return DBI_fetchrow_array(sth); }
StradaValue* main__DBI_fetchrow_hashref(StradaValue* sth) { return DBI_fetchrow_hashref(sth); }
StradaValue* main__DBI_fetchall_arrayref(StradaValue* sth) { return DBI_fetchall_arrayref(sth); }
StradaValue* main__DBI_selectall_arrayref(StradaValue* dbh, StradaValue* sql) { return DBI_selectall_arrayref(dbh, sql); }
StradaValue* main__DBI_selectall_arrayref_bind(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_selectall_arrayref_bind(dbh, sql, params); }
StradaValue* main__DBI_begin_work(StradaValue* dbh) { return DBI_begin_work(dbh); }
StradaValue* main__DBI_commit(StradaValue* dbh) { return DBI_commit(dbh); }
StradaValue* main__DBI_rollback(StradaValue* dbh) { return DBI_rollback(dbh); }
StradaValue* main__DBI_quote(StradaValue* dbh, StradaValue* value) { return DBI_quote(dbh, value); }
StradaValue* main__DBI_last_insert_id(StradaValue* dbh) { return DBI_last_insert_id(dbh); }
StradaValue* main__DBI_errstr(StradaValue* dbh) { return DBI_errstr(dbh); }
StradaValue* main__DBI_err(StradaValue* dbh) { return DBI_err(dbh); }
void main__DBI_set_raise_error(StradaValue* dbh, StradaValue* flag) { return DBI_set_raise_error(dbh, flag); }
void main__DBI_finish(StradaValue* sth) { return DBI_finish(sth); }
StradaValue* main__DBI_rows(StradaValue* sth) { return DBI_rows(sth); }
StradaValue* main__DBI_column_names(StradaValue* sth) { return DBI_column_names(sth); }
StradaValue* main__DBI_ping(StradaValue* dbh) { return DBI_ping(dbh); }
StradaValue* main__DBI_selectall_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_selectall_hashref(dbh, sql, params); }
StradaValue* main__DBI_selectrow_hashref(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_selectrow_hashref(dbh, sql, params); }
StradaValue* main__DBI_selectcol(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_selectcol(dbh, sql, params); }
StradaValue* main__DBI_insert_get_id(StradaValue* dbh, StradaValue* sql, StradaValue* params) { return DBI_insert_get_id(dbh, sql, params); }
void main__Nesso_log_sql(StradaValue* self, StradaValue* sql, StradaValue* params) { return Nesso_log_sql(self, sql, params); }
StradaValue* main__Nesso_get_schema(StradaValue* self, StradaValue* model) { return Nesso_get_schema(self, model); }
StradaValue* main__Nesso_build_where_clause(StradaValue* self, StradaValue* conds, StradaValue* params) { return Nesso_build_where_clause(self, conds, params); }
StradaValue* main__Nesso_wrap_record(StradaValue* self, StradaValue* model, StradaValue* row) { return Nesso_wrap_record(self, model, row); }
StradaValue* main__Nesso_tag_rows(StradaValue* self, StradaValue* model, StradaValue* rows) { return Nesso_tag_rows(self, model, rows); }
StradaValue* main__Nesso_new(StradaValue* dbh) { return Nesso_new(dbh); }
void main__Nesso_set_db(StradaValue* self, StradaValue* db) { return Nesso_set_db(self, db); }
StradaValue* main__Nesso_get_db(StradaValue* self) { return Nesso_get_db(self); }
void main__Nesso_set_debug(StradaValue* self, StradaValue* on) { return Nesso_set_debug(self, on); }
StradaValue* main__Nesso_get_debug(StradaValue* self) { return Nesso_get_debug(self); }
void main__Nesso_define(StradaValue* self, StradaValue* name, StradaValue* schema) { return Nesso_define(self, name, schema); }
StradaValue* main__Nesso_columns(StradaValue* self, StradaValue* model) { return Nesso_columns(self, model); }
StradaValue* main__Nesso_create(StradaValue* self, StradaValue* model, StradaValue* attrs) { return Nesso_create(self, model, attrs); }
StradaValue* main__Nesso_save(StradaValue* self, StradaValue* record) { return Nesso_save(self, record); }
StradaValue* main__Nesso_find(StradaValue* self, StradaValue* model, StradaValue* id) { return Nesso_find(self, model, id); }
StradaValue* main__Nesso_find_by(StradaValue* self, StradaValue* model, StradaValue* conds) { return Nesso_find_by(self, model, conds); }
StradaValue* main__Nesso_where(StradaValue* self, StradaValue* model, StradaValue* conds) { return Nesso_where(self, model, conds); }
StradaValue* main__Nesso_all(StradaValue* self, StradaValue* model) { return Nesso_all(self, model); }
StradaValue* main__Nesso_count(StradaValue* self, StradaValue* model, StradaValue* conds) { return Nesso_count(self, model, conds); }
StradaValue* main__Nesso_delete(StradaValue* self, StradaValue* record) { return Nesso_delete(self, record); }
StradaValue* main__Nesso_query(StradaValue* self, StradaValue* sql, StradaValue* params) { return Nesso_query(self, sql, params); }
void main__Nesso_transaction(StradaValue* self, StradaValue* cb) { return Nesso_transaction(self, cb); }
void main__Nesso_has_many(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* fk) { return Nesso_has_many(self, owner, name, fk); }
void main__Nesso_belongs_to(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk) { return Nesso_belongs_to(self, owner, name, target, fk); }
void main__Nesso_has_one(StradaValue* self, StradaValue* owner, StradaValue* name, StradaValue* target, StradaValue* fk) { return Nesso_has_one(self, owner, name, target, fk); }
StradaValue* main__Nesso_related(StradaValue* self, StradaValue* record, StradaValue* name) { return Nesso_related(self, record, name); }
StradaValue* main__Nesso_clone(StradaValue* self, StradaValue* new_dbh) { return Nesso_clone(self, new_dbh); }
StradaValue* main__Nesso_Record_save(StradaValue* self) { return Nesso_Record_save(self); }
StradaValue* main__Nesso_Record_update(StradaValue* self, StradaValue* attrs) { return Nesso_Record_update(self, attrs); }
StradaValue* main__Nesso_Record_delete(StradaValue* self) { return Nesso_Record_delete(self); }
StradaValue* main__Nesso_Record_reload(StradaValue* self) { return Nesso_Record_reload(self); }
StradaValue* main__Nesso_Record_related(StradaValue* self, StradaValue* name) { return Nesso_Record_related(self, name); }
StradaValue* main__Nesso_Record_model(StradaValue* self) { return Nesso_Record_model(self); }
StradaValue* main__Nesso_Record_id(StradaValue* self) { return Nesso_Record_id(self); }
StradaValue* main__Nesso_Record_is_new(StradaValue* self) { return Nesso_Record_is_new(self); }
StradaValue* main__AdminUser_is_super_admin(StradaValue* self) { return AdminUser_is_super_admin(self); }
void main__AdminUser_promote(StradaValue* self) { return AdminUser_promote(self); }
void main__ok(StradaValue* cond, StradaValue* msg) { return ok(cond, msg); }


/* Strada export metadata for import_lib */
static const char* __strada_export_info(void) {
    return "func:DBI_connect:scalar:3:str,str,str:-1\nfunc:DBI_connect_attrs:scalar:4:str,str,str,scalar:-1\nfunc:DBI_disconnect:void:1:scalar:-1\nfunc:DBI_prepare:scalar:2:scalar,str:-1\nfunc:DBI__bind_params:void:2:int,scalar:-1\nfunc:DBI_execute:int:2:scalar,scalar:-1\nfunc:DBI_exec:int:3:scalar,str,scalar:-1\nfunc:DBI_do_sql:int:2:scalar,str:-1\nfunc:DBI_fetchrow_array:scalar:1:scalar:-1\nfunc:DBI_fetchrow_hashref:scalar:1:scalar:-1\nfunc:DBI_fetchall_arrayref:scalar:1:scalar:-1\nfunc:DBI_selectall_arrayref:scalar:2:scalar,str:-1\nfunc:DBI_selectall_arrayref_bind:scalar:3:scalar,str,scalar:-1\nfunc:DBI_begin_work:int:1:scalar:-1\nfunc:DBI_commit:int:1:scalar:-1\nfunc:DBI_rollback:int:1:scalar:-1\nfunc:DBI_quote:str:2:scalar,str:-1\nfunc:DBI_last_insert_id:int:1:scalar:-1\nfunc:DBI_errstr:str:1:scalar:-1\nfunc:DBI_err:int:1:scalar:-1\nfunc:DBI_set_raise_error:void:2:scalar,int:-1\nfunc:DBI_finish:void:1:scalar:-1\nfunc:DBI_rows:int:1:scalar:-1\nfunc:DBI_column_names:scalar:1:scalar:-1\nfunc:DBI_ping:int:1:scalar:-1\nfunc:DBI_selectall_hashref:scalar:3:scalar,str,scalar:-1\nfunc:DBI_selectrow_hashref:scalar:3:scalar,str,scalar:-1\nfunc:DBI_selectcol:scalar:3:scalar,str,scalar:-1\nfunc:DBI_insert_get_id:int:3:scalar,str,scalar:-1\nfunc:Nesso_log_sql:void:3:scalar,str,scalar:-1\nfunc:Nesso_get_schema:scalar:2:scalar,str:-1\nfunc:Nesso_build_where_clause:str:3:scalar,scalar,scalar:-1\nfunc:Nesso_wrap_record:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_tag_rows:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_new:scalar:1:scalar:-1\nfunc:Nesso_set_db:void:2:scalar,scalar:-1\nfunc:Nesso_get_db:scalar:1:scalar:-1\nfunc:Nesso_set_debug:void:2:scalar,int:-1\nfunc:Nesso_get_debug:int:1:scalar:-1\nfunc:Nesso_define:void:3:scalar,str,scalar:-1\nfunc:Nesso_columns:scalar:2:scalar,str:-1\nfunc:Nesso_create:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_save:int:2:scalar,scalar:-1\nfunc:Nesso_find:scalar:3:scalar,str,int:-1\nfunc:Nesso_find_by:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_where:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_all:scalar:2:scalar,str:-1\nfunc:Nesso_count:int:3:scalar,str,scalar:-1\nfunc:Nesso_delete:int:2:scalar,scalar:-1\nfunc:Nesso_query:scalar:3:scalar,str,scalar:-1\nfunc:Nesso_transaction:void:2:scalar,scalar:-1\nfunc:Nesso_has_many:void:4:scalar,str,str,str:-1\nfunc:Nesso_belongs_to:void:5:scalar,str,str,str,str:-1\nfunc:Nesso_has_one:void:5:scalar,str,str,str,str:-1\nfunc:Nesso_related:scalar:3:scalar,scalar,str:-1\nfunc:Nesso_clone:scalar:2:scalar,scalar:-1\nfunc:Nesso_Record_save:int:1:scalar:-1\nfunc:Nesso_Record_update:int:2:scalar,scalar:-1\nfunc:Nesso_Record_delete:int:1:scalar:-1\nfunc:Nesso_Record_reload:scalar:1:scalar:-1\nfunc:Nesso_Record_related:scalar:2:scalar,str:-1\nfunc:Nesso_Record_model:str:1:scalar:-1\nfunc:Nesso_Record_id:scalar:1:scalar:-1\nfunc:Nesso_Record_is_new:int:1:scalar:-1\nfunc:AdminUser_is_super_admin:int:1:scalar:-1\nfunc:AdminUser_promote:void:1:scalar:-1\nfunc:ok:void:2:int,str:-1\n";
}

/* Strada module version */
static const char* __strada_version(void) {
    return "";
}
