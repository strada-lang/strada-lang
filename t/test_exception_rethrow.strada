# Test: Exception re-throw from catch blocks
# This test verifies that variables are properly cleaned up when re-throwing
# from a catch block, and that the cleanup doesn't cause double-frees.

func inner_throw(str $msg) void {
    my str $local = "inner local: " . $msg;
    throw $local;
}

func middle(str $data) void {
    my str $middle_local = "middle: " . $data;
    try {
        inner_throw($middle_local);
    } catch ($e) {
        my str $caught = "caught in middle: " . $e;
        throw $caught;  # Re-throw with new message
    }
}

func main() int {
    say("Testing exception re-throw...");
    my int $i = 0;
    my int $count = 0;
    while ($i < 5) {
        try {
            middle("iteration " . $i);
        } catch ($e) {
            $count = $count + 1;
        }
        $i = $i + 1;
    }
    
    if ($count == 5) {
        say("PASS: All 5 exceptions caught");
        return 0;
    } else {
        say("FAIL: Expected 5 catches, got " . $count);
        return 1;
    }
}
