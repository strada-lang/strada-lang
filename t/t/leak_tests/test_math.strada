#!/usr/bin/env strada
# Test math operations for memory leaks
# Run: valgrind --leak-check=full ./test_math

func main() int {
    say("Testing math operations for memory leaks...");
    my int $iterations = 100;

    # Test basic arithmetic
    say("  Basic arithmetic...");
    my int $i = 0;
    while ($i < $iterations) {
        my int $a = 10;
        my int $b = 3;
        my int $add = $a + $b;
        my int $sub = $a - $b;
        my int $mul = $a * $b;
        # Note: / operator does float division in Strada, use num for result
        my num $div = $a / $b;
        my int $mod = $a % $b;

        if ($add != 13 || $sub != 7 || $mul != 30 || $div < 3.3 || $div > 3.4 || $mod != 1) {
            say("    FAIL: basic arithmetic");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test floating point
    say("  Floating point...");
    $i = 0;
    while ($i < $iterations) {
        my num $x = 3.14159;
        my num $y = 2.71828;
        my num $sum = $x + $y;
        my num $prod = $x * $y;

        if ($sum < 5.8 || $sum > 5.9) {
            say("    FAIL: float sum");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::sin/cos/tan
    say("  math::sin/cos/tan...");
    $i = 0;
    while ($i < $iterations) {
        my num $angle = 0.5;
        my num $s = math::sin($angle);
        my num $c = math::cos($angle);
        my num $t = math::tan($angle);

        # sin(0.5) ≈ 0.479
        if ($s < 0.47 || $s > 0.49) {
            say("    FAIL: sin");
            return 1;
        }
        # cos(0.5) ≈ 0.878
        if ($c < 0.87 || $c > 0.89) {
            say("    FAIL: cos");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::sqrt
    say("  math::sqrt...");
    $i = 0;
    while ($i < $iterations) {
        my num $sq = math::sqrt(16.0);
        if ($sq < 3.99 || $sq > 4.01) {
            say("    FAIL: sqrt(16) = " . $sq);
            return 1;
        }
        my num $sq2 = math::sqrt(2.0);
        if ($sq2 < 1.41 || $sq2 > 1.42) {
            say("    FAIL: sqrt(2)");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::pow
    say("  math::pow...");
    $i = 0;
    while ($i < $iterations) {
        my num $p1 = math::pow(2.0, 10.0);
        my num $p2 = math::pow(3.0, 3.0);

        if ($p1 < 1023.9 || $p1 > 1024.1) {
            say("    FAIL: pow(2,10)");
            return 1;
        }
        if ($p2 < 26.9 || $p2 > 27.1) {
            say("    FAIL: pow(3,3)");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::log/exp
    say("  math::log/exp...");
    $i = 0;
    while ($i < $iterations) {
        my num $lg = math::log(2.71828);
        my num $ex = math::exp(1.0);

        # log(e) ≈ 1
        if ($lg < 0.99 || $lg > 1.01) {
            say("    FAIL: log(e)");
            return 1;
        }
        # exp(1) ≈ e ≈ 2.718
        if ($ex < 2.71 || $ex > 2.72) {
            say("    FAIL: exp(1)");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::floor/ceil
    say("  math::floor/ceil...");
    $i = 0;
    while ($i < $iterations) {
        my num $f1 = math::floor(3.7);
        my num $f2 = math::floor(-3.7);
        my num $c1 = math::ceil(3.2);
        my num $c2 = math::ceil(-3.2);

        if ($f1 != 3.0) {
            say("    FAIL: floor(3.7)");
            return 1;
        }
        if ($f2 != -4.0) {
            say("    FAIL: floor(-3.7)");
            return 1;
        }
        if ($c1 != 4.0) {
            say("    FAIL: ceil(3.2)");
            return 1;
        }
        if ($c2 != -3.0) {
            say("    FAIL: ceil(-3.2)");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::abs
    say("  math::abs...");
    $i = 0;
    while ($i < $iterations) {
        my num $a1 = math::abs(-5.5);
        my num $a2 = math::abs(5.5);
        my num $a3 = math::abs(-42.0);

        if ($a1 != 5.5 || $a2 != 5.5 || $a3 != 42.0) {
            say("    FAIL: abs");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test math::round
    say("  math::round...");
    $i = 0;
    while ($i < $iterations) {
        my num $r1 = math::round(3.4);
        my num $r2 = math::round(3.5);
        my num $r3 = math::round(-3.5);

        if ($r1 != 3.0) {
            say("    FAIL: round(3.4)");
            return 1;
        }
        if ($r2 != 4.0) {
            say("    FAIL: round(3.5)");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Note: int() function test skipped due to type keyword conflict
    # int() as a function conflicts with 'int' type keyword in parser

    # Test rand()
    say("  rand()...");
    $i = 0;
    while ($i < $iterations) {
        my int $r = math::rand();
        # Just make sure it doesn't crash and returns something
        if ($r < 0) {
            # rand() returns positive values
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test comparison operators
    say("  Comparison operators...");
    $i = 0;
    while ($i < $iterations) {
        my int $a = 5;
        my int $b = 10;
        my int $c = 5;

        if (!($a < $b)) {
            say("    FAIL: <");
            return 1;
        }
        if (!($b > $a)) {
            say("    FAIL: >");
            return 1;
        }
        if (!($a <= $c)) {
            say("    FAIL: <=");
            return 1;
        }
        if (!($a >= $c)) {
            say("    FAIL: >=");
            return 1;
        }
        if (!($a == $c)) {
            say("    FAIL: ==");
            return 1;
        }
        if (!($a != $b)) {
            say("    FAIL: !=");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test spaceship operator
    say("  Spaceship operator (<=>)...");
    $i = 0;
    while ($i < $iterations) {
        my int $r1 = 5 <=> 10;
        my int $r2 = 10 <=> 5;
        my int $r3 = 5 <=> 5;

        if ($r1 != -1 || $r2 != 1 || $r3 != 0) {
            say("    FAIL: <=>");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    say("All math tests passed!");
    return 0;
}
