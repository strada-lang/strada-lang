#!/usr/bin/env strada
# Test sys::random_bytes and sys::random_bytes_hex for memory leaks
# Run: valgrind --leak-check=full ./test_random

func main() int {
    say("Testing sys::random_bytes functions for memory leaks...");

    # Test random_bytes_hex - 100 iterations
    say("  sys::random_bytes_hex()...");
    my int $i = 0;
    my str $prev = "";
    while ($i < 100) {
        my str $hex = sys::random_bytes_hex(32);

        # Verify length (32 bytes = 64 hex chars)
        if (length($hex) != 64) {
            say("    FAIL: expected 64 chars, got " . length($hex));
            return 1;
        }

        # Verify randomness (should be different each time)
        if ($hex eq $prev && $i > 0) {
            say("    FAIL: got duplicate random value");
            return 1;
        }
        $prev = $hex;
        $i = $i + 1;
    }
    say("    PASS");

    # Test random_bytes (raw) - 100 iterations
    say("  sys::random_bytes()...");
    $i = 0;
    while ($i < 100) {
        my str $raw = sys::random_bytes(32);

        # Verify length
        if (sys::byte_length($raw) != 32) {
            say("    FAIL: expected 32 bytes, got " . sys::byte_length($raw));
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    # Test different sizes
    say("  Testing various sizes...");
    my array @sizes = (1, 8, 16, 32, 64, 128, 256);
    my int $j = 0;
    while ($j < size(@sizes)) {
        my int $sz = $sizes[$j];
        $i = 0;
        while ($i < 20) {
            my str $hex = sys::random_bytes_hex($sz);
            if (length($hex) != $sz * 2) {
                say("    FAIL: size " . $sz . " expected " . ($sz * 2) . " hex chars, got " . length($hex));
                return 1;
            }
            my str $raw = sys::random_bytes($sz);
            if (sys::byte_length($raw) != $sz) {
                say("    FAIL: size " . $sz . " expected " . $sz . " bytes, got " . sys::byte_length($raw));
                return 1;
            }
            $i = $i + 1;
        }
        $j = $j + 1;
    }
    say("    PASS");

    # Test with variable argument (not just literal)
    say("  Testing with variable arguments...");
    $i = 0;
    while ($i < 50) {
        my int $size = 16 + ($i % 32);
        my str $hex = sys::random_bytes_hex($size);
        if (length($hex) != $size * 2) {
            say("    FAIL: variable size test failed");
            return 1;
        }
        $i = $i + 1;
    }
    say("    PASS");

    say("All sys::random_bytes tests passed!");
    return 0;
}
